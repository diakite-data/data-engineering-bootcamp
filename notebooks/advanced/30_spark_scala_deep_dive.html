<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ğŸš€ Spark &amp; Scala Deep Dive â€“ Bootcamp Data Engineering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../notebooks/advanced/31_data_engineering_for_ml.html" rel="next">
<link href="../../notebooks/advanced/29_distributed_messaging.html" rel="prev">
<link href="../../assets/images/favicon.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-fc8d3d93f0a84b7619e1f8ff6eb63d42.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-fc8d3d93f0a84b7619e1f8ff6eb63d42.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-fc8d3d93f0a84b7619e1f8ff6eb63d42.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-650b7f2e5e620ac1d2c57104dfb9acc6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-d774acf7b923ebe64b2a3dd04cb6a08b.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/bootstrap/bootstrap-650b7f2e5e620ac1d2c57104dfb9acc6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "Pas de rÃ©sultats",
    "search-matching-documents-text": "documents trouvÃ©s",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer",
    "search-label": "Recherche"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-NZSBZFMZN7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-NZSBZFMZN7', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;family=JetBrains+Mono:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
<meta name="author" content="Diakite Data">
<meta name="keywords" content="data engineering, spark, kafka, python, kubernetes, lakehouse, delta lake, bootcamp, formation, tutoriel">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://diakite-data.github.io/data-engineering-bootcamp">


<meta property="og:title" content="ğŸš€ Spark &amp; Scala Deep Dive â€“ Bootcamp Data Engineering">
<meta property="og:description" content="Programme complet Data Engineering â€” Du dÃ©butant au Senior Engineer">
<meta property="og:site_name" content="Bootcamp Data Engineering">
<meta property="og:locale" content="fr_FR">
<meta name="twitter:title" content="ğŸš€ Spark &amp; Scala Deep Dive â€“ Bootcamp Data Engineering">
<meta name="twitter:description" content="Programme complet Data Engineering â€” Du dÃ©butant au Senior Engineer">
<meta name="twitter:creator" content="@diakite_data">
<meta name="twitter:site" content="@diakite_data">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/logo.svg" alt="Data Engineering Bootcamp" class="navbar-logo light-content">
    <img src="../../assets/images/logo.svg" alt="Data Engineering Bootcamp" class="navbar-logo dark-content">
    </a>
  </div>
            <div id="quarto-search" class="" title="Recherche"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Basculer la navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">ğŸ  Accueil</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-programme" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">ğŸ“˜ Programme</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-programme">    
        <li>
    <a class="dropdown-item" href="../../notebooks/beginner/01_intro_data_engineering.html">
 <span class="dropdown-text">ğŸŸ¦ Niveau DÃ©butant</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../notebooks/intermediate/14_docker_for_data_engineers.html">
 <span class="dropdown-text">ğŸŸ© Niveau IntermÃ©diaire</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../notebooks/advanced/27_kubernetes_deep_dive.html">
 <span class="dropdown-text">ğŸŸ¥ Niveau AvancÃ©</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../curriculum.html">
 <span class="dropdown-text">ğŸ“Š Vue dâ€™ensemble</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-ressources" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">ğŸ› ï¸ Ressources</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-ressources">    
        <li>
    <a class="dropdown-item" href="../../resources/documentation.html">
 <span class="dropdown-text">ğŸ“š Documentation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resources/setup.html">
 <span class="dropdown-text">ğŸ”§ Setup Environnement</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../resources/faq.html">
 <span class="dropdown-text">â“ FAQ</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../resources/links.html">
 <span class="dropdown-text">ğŸ”— Liens Utiles</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/diakite-data/data-engineering-bootcamp"> <i class="bi bi-github" role="img" aria-label="GitHub Repository">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Basculer le mode sombre"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Basculer en mode lecteur">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latÃ©rale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">ğŸŸ¥ Niveau 3 : AvancÃ©</li><li class="breadcrumb-item"><a href="../../notebooks/advanced/30_spark_scala_deep_dive.html">âš¡ Processing AvancÃ©</a></li><li class="breadcrumb-item"><a href="../../notebooks/advanced/30_spark_scala_deep_dive.html">30 Â· Spark &amp; Scala Deep Dive</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latÃ©rale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Recherche" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Recherche"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸŸ¦ Niveau 1 : DÃ©butant</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="px-0"><hr class="sidebar-divider hi "></li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“Œ Fondations</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/01_intro_data_engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">01 Â· Introduction au Data Engineering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/02_bash_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">02 Â· Linux &amp; Bash</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/03_git_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">03 Â· Git &amp; Versioning</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ Python</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/04_python_basics_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">04 Â· Python Fondamental</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/05_python_data_processing_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">05 Â· Python Data Processing</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ—„ï¸ Bases de DonnÃ©es</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/06_intro_relational_databases.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">06 Â· Introduction aux BDD Relationnelles</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/07_sql_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">07 Â· SQL pour Data Engineers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ“Š Big Data &amp; NoSQL</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/08_intro_big_data_distributed.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">08 Â· Introduction Big Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/09_mongodb_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">09 Â· MongoDB</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/10_elasticsearch_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">10 Â· Elasticsearch</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">âš¡ Spark &amp; Orchestration</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/11_pyspark_for_data_engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">11 Â· Introduction PySpark</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/12_orchestration_pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">12 Â· Orchestration de Pipelines</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ Bonus</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/13_fastapi_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">13 Â· FastAPI pour Data Engineers</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="px-0"><hr class="sidebar-divider hi "></li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/beginner/14_projet_integrateur_debutant.ipynb" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ğŸ® <strong>Projet DÃ©butant</strong></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸŸ© Niveau 2 : IntermÃ©diaire</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="px-0"><hr class="sidebar-divider hi "></li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ³ Containers &amp; Cloud</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/14_docker_for_data_engineers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">14 Â· Docker pour Data Engineers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/15_kubernetes_fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">15 Â· Kubernetes Fondamentaux</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/16_k8s_for_data_workloads.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">16 Â· K8s pour Data Workloads</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸš€ High Performance Python</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/17_polars_for_data_engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">17 Â· Polars pour Data Engineering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/18_high_performance_python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">18 Â· High Performance Python</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false">
 <span class="menu-text">âš¡ Spark AvancÃ©</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/19_pyspark_advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">19 Â· PySpark AvancÃ©</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/20_spark_sql_deep_dive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">20 Â· Spark SQL Deep Dive</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/21_spark_on_kubernetes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">21 Â· Spark on Kubernetes</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ  Lakehouse &amp; Streaming &amp; Cloud</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/22_cloud_and_object_storage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">22 Â· Cloud Object Storage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/23_table_formats_delta_iceberg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">23 Â· Table Formats (Delta, Iceberg)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/24_kafka_streaming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">24 Â· Kafka &amp; Streaming</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ”§ Industrialisation</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/25_dbt_data_quality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">25 Â· dbt &amp; Data Quality</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="px-0"><hr class="sidebar-divider hi "></li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/intermediate/26_projet_integrateur.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ğŸ“¦ <strong>Projet IntermÃ©diaire</strong> (Olist)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="true">
 <span class="menu-text">ğŸŸ¥ Niveau 3 : AvancÃ©</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" role="navigation" aria-expanded="true" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="px-0"><hr class="sidebar-divider hi "></li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false">
 <span class="menu-text">â˜¸ï¸ Infrastructure AvancÃ©e</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-15" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-15" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/27_kubernetes_deep_dive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">27 Â· Kubernetes Deep Dive</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/28_advanced_orchestration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">28 Â· Orchestration AvancÃ©e</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/29_distributed_messaging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">29 Â· Messaging DistribuÃ© (Kafka, Pulsar)</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="true">
 <span class="menu-text">âš¡ Processing AvancÃ©</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-16" role="navigation" aria-expanded="true" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-16" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/30_spark_scala_deep_dive.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">30 Â· Spark &amp; Scala Deep Dive</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ¤– ML &amp; Analytics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-17" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-17" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/31_data_engineering_for_ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">31 Â· Data Engineering pour le ML</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/33_realtime_olap_dashboards.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">33 Â· Realtime OLAP &amp; Dashboards</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ›ï¸ Architecture &amp; Governance</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-18" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-18" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/32_data_mesh_contracts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">32 Â· Data Mesh &amp; Contracts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/34_architecture_patterns_decisions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">34 Â· Patterns &amp; DÃ©cisions d'Architecture</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" role="navigation" aria-expanded="false">
 <span class="menu-text">ğŸ‘” Leadership</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-19" role="navigation" aria-expanded="false" aria-label="Basculer la section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-19" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../notebooks/advanced/35_leadership_tradeoffs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">35 Â· Leadership &amp; Trade-offs</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">ğŸ“‘ Sommaire</h2>
   
  <ul>
  <li><a href="#prÃ©requis" id="toc-prÃ©requis" class="nav-link active" data-scroll-target="#prÃ©requis">PrÃ©requis</a></li>
  <li><a href="#objectifs-du-module" id="toc-objectifs-du-module" class="nav-link" data-scroll-target="#objectifs-du-module">ğŸ¯ Objectifs du module</a></li>
  <li><a href="#scala-pour-data-engineers" id="toc-scala-pour-data-engineers" class="nav-link" data-scroll-target="#scala-pour-data-engineers">1. Scala pour Data Engineers</a>
  <ul class="collapse">
  <li><a href="#pourquoi-scala-pour-spark" id="toc-pourquoi-scala-pour-spark" class="nav-link" data-scroll-target="#pourquoi-scala-pour-spark">1.1 Pourquoi Scala pour Spark ?</a></li>
  <li><a href="#syntaxe-essentielle" id="toc-syntaxe-essentielle" class="nav-link" data-scroll-target="#syntaxe-essentielle">1.2 Syntaxe Essentielle</a></li>
  <li><a href="#collections-fonctionnelles" id="toc-collections-fonctionnelles" class="nav-link" data-scroll-target="#collections-fonctionnelles">1.3 Collections Fonctionnelles</a></li>
  <li><a href="#option-gÃ©rer-les-valeurs-absentes" id="toc-option-gÃ©rer-les-valeurs-absentes" class="nav-link" data-scroll-target="#option-gÃ©rer-les-valeurs-absentes">1.4 Option : GÃ©rer les valeurs absentes</a></li>
  <li><a href="#case-classes-et-pattern-matching" id="toc-case-classes-et-pattern-matching" class="nav-link" data-scroll-target="#case-classes-et-pattern-matching">1.5 Case Classes et Pattern Matching</a></li>
  <li><a href="#sealed-traits-et-adt-algebraic-data-types" id="toc-sealed-traits-et-adt-algebraic-data-types" class="nav-link" data-scroll-target="#sealed-traits-et-adt-algebraic-data-types">1.6 Sealed Traits et ADT (Algebraic Data Types) ğŸ”¥</a></li>
  <li><a href="#gestion-derreurs-either-et-try" id="toc-gestion-derreurs-either-et-try" class="nav-link" data-scroll-target="#gestion-derreurs-either-et-try">1.7 Gestion dâ€™Erreurs : Either et Try ğŸ”¥</a></li>
  </ul></li>
  <li><a href="#environnements-de-dÃ©veloppement" id="toc-environnements-de-dÃ©veloppement" class="nav-link" data-scroll-target="#environnements-de-dÃ©veloppement">2. Environnements de DÃ©veloppement</a>
  <ul class="collapse">
  <li><a href="#scala-dans-jupyter-notebook-avec-almond" id="toc-scala-dans-jupyter-notebook-avec-almond" class="nav-link" data-scroll-target="#scala-dans-jupyter-notebook-avec-almond">2.1 Scala dans Jupyter Notebook avec Almond</a></li>
  <li><a href="#intellij-idea" id="toc-intellij-idea" class="nav-link" data-scroll-target="#intellij-idea">2.2 IntelliJ IDEA</a></li>
  <li><a href="#quand-utiliser-quoi" id="toc-quand-utiliser-quoi" class="nav-link" data-scroll-target="#quand-utiliser-quoi">2.3 Quand utiliser quoi ?</a></li>
  </ul></li>
  <li><a href="#projet-complet-avec-intellij-step-by-step" id="toc-projet-complet-avec-intellij-step-by-step" class="nav-link" data-scroll-target="#projet-complet-avec-intellij-step-by-step">3. Projet Complet avec IntelliJ (Step-by-Step)</a>
  <ul class="collapse">
  <li><a href="#crÃ©er-le-projet" id="toc-crÃ©er-le-projet" class="nav-link" data-scroll-target="#crÃ©er-le-projet">3.1 CrÃ©er le projet</a></li>
  <li><a href="#structure-du-projet" id="toc-structure-du-projet" class="nav-link" data-scroll-target="#structure-du-projet">3.2 Structure du projet</a></li>
  <li><a href="#fichiers-de-configuration" id="toc-fichiers-de-configuration" class="nav-link" data-scroll-target="#fichiers-de-configuration">3.3 Fichiers de configuration</a></li>
  <li><a href="#code-scala" id="toc-code-scala" class="nav-link" data-scroll-target="#code-scala">3.4 Code Scala</a></li>
  <li><a href="#donnÃ©es-de-test" id="toc-donnÃ©es-de-test" class="nav-link" data-scroll-target="#donnÃ©es-de-test">3.5 DonnÃ©es de test</a></li>
  <li><a href="#exÃ©cuter-dans-intellij" id="toc-exÃ©cuter-dans-intellij" class="nav-link" data-scroll-target="#exÃ©cuter-dans-intellij">3.6 ExÃ©cuter dans IntelliJ</a></li>
  <li><a href="#builder-le-jar" id="toc-builder-le-jar" class="nav-link" data-scroll-target="#builder-le-jar">3.7 Builder le JAR</a></li>
  <li><a href="#exÃ©cuter-avec-spark-submit-local" id="toc-exÃ©cuter-avec-spark-submit-local" class="nav-link" data-scroll-target="#exÃ©cuter-avec-spark-submit-local">3.8 ExÃ©cuter avec spark-submit (local)</a></li>
  <li><a href="#exÃ©cuter-sur-cluster-yarnk8s" id="toc-exÃ©cuter-sur-cluster-yarnk8s" class="nav-link" data-scroll-target="#exÃ©cuter-sur-cluster-yarnk8s">3.9 ExÃ©cuter sur cluster (YARN/K8s)</a></li>
  </ul></li>
  <li><a href="#connecteurs-jars-et-configuration" id="toc-connecteurs-jars-et-configuration" class="nav-link" data-scroll-target="#connecteurs-jars-et-configuration">4. Connecteurs : JARs et Configuration</a>
  <ul class="collapse">
  <li><a href="#jars-requis-par-source-de-donnÃ©es" id="toc-jars-requis-par-source-de-donnÃ©es" class="nav-link" data-scroll-target="#jars-requis-par-source-de-donnÃ©es">4.1 JARs requis par source de donnÃ©es</a></li>
  <li><a href="#ajouter-dans-build.sbt" id="toc-ajouter-dans-build.sbt" class="nav-link" data-scroll-target="#ajouter-dans-build.sbt">4.2 Ajouter dans build.sbt</a></li>
  <li><a href="#spark-submit-jars-vs-packages" id="toc-spark-submit-jars-vs-packages" class="nav-link" data-scroll-target="#spark-submit-jars-vs-packages">4.3 spark-submit : â€“jars vs â€“packages</a></li>
  <li><a href="#exemples-de-connexion" id="toc-exemples-de-connexion" class="nav-link" data-scroll-target="#exemples-de-connexion">4.4 Exemples de connexion</a></li>
  </ul></li>
  <li><a href="#catalyst-optimizer" id="toc-catalyst-optimizer" class="nav-link" data-scroll-target="#catalyst-optimizer">5. Catalyst Optimizer</a>
  <ul class="collapse">
  <li><a href="#phases-doptimisation" id="toc-phases-doptimisation" class="nav-link" data-scroll-target="#phases-doptimisation">5.1 Phases dâ€™optimisation</a></li>
  <li><a href="#lire-un-plan-dexÃ©cution" id="toc-lire-un-plan-dexÃ©cution" class="nav-link" data-scroll-target="#lire-un-plan-dexÃ©cution">5.2 Lire un plan dâ€™exÃ©cution</a></li>
  <li><a href="#exemple-de-plan" id="toc-exemple-de-plan" class="nav-link" data-scroll-target="#exemple-de-plan">5.3 Exemple de plan</a></li>
  <li><a href="#cost-based-optimization-cbo" id="toc-cost-based-optimization-cbo" class="nav-link" data-scroll-target="#cost-based-optimization-cbo">5.4 Cost-Based Optimization (CBO)</a></li>
  </ul></li>
  <li><a href="#adaptive-query-execution-aqe" id="toc-adaptive-query-execution-aqe" class="nav-link" data-scroll-target="#adaptive-query-execution-aqe">6. Adaptive Query Execution (AQE)</a>
  <ul class="collapse">
  <li><a href="#fonctionnalitÃ©s" id="toc-fonctionnalitÃ©s" class="nav-link" data-scroll-target="#fonctionnalitÃ©s">6.1 FonctionnalitÃ©s</a></li>
  <li><a href="#configuration" id="toc-configuration" class="nav-link" data-scroll-target="#configuration">6.2 Configuration</a></li>
  <li><a href="#voir-aqe-en-action" id="toc-voir-aqe-en-action" class="nav-link" data-scroll-target="#voir-aqe-en-action">6.3 Voir AQE en action</a></li>
  </ul></li>
  <li><a href="#tungsten-engine" id="toc-tungsten-engine" class="nav-link" data-scroll-target="#tungsten-engine">7. Tungsten Engine</a>
  <ul class="collapse">
  <li><a href="#optimisations-tungsten" id="toc-optimisations-tungsten" class="nav-link" data-scroll-target="#optimisations-tungsten">7.1 Optimisations Tungsten</a></li>
  <li><a href="#whole-stage-code-generation" id="toc-whole-stage-code-generation" class="nav-link" data-scroll-target="#whole-stage-code-generation">7.2 Whole-Stage Code Generation</a></li>
  <li><a href="#voir-le-code-gÃ©nÃ©rÃ©" id="toc-voir-le-code-gÃ©nÃ©rÃ©" class="nav-link" data-scroll-target="#voir-le-code-gÃ©nÃ©rÃ©">7.3 Voir le code gÃ©nÃ©rÃ©</a></li>
  </ul></li>
  <li><a href="#memory-management-tuning" id="toc-memory-management-tuning" class="nav-link" data-scroll-target="#memory-management-tuning">8. Memory Management &amp; Tuning</a>
  <ul class="collapse">
  <li><a href="#architecture-mÃ©moire-spark" id="toc-architecture-mÃ©moire-spark" class="nav-link" data-scroll-target="#architecture-mÃ©moire-spark">8.1 Architecture MÃ©moire Spark</a></li>
  <li><a href="#configurations-mÃ©moire" id="toc-configurations-mÃ©moire" class="nav-link" data-scroll-target="#configurations-mÃ©moire">8.2 Configurations MÃ©moire</a></li>
  <li><a href="#pourquoi-80-des-jobs-spark-sont-lents" id="toc-pourquoi-80-des-jobs-spark-sont-lents" class="nav-link" data-scroll-target="#pourquoi-80-des-jobs-spark-sont-lents">8.3 Pourquoi 80% des Jobs Spark sont Lents ğŸ”¥</a></li>
  <li><a href="#diagnostic-toolkit" id="toc-diagnostic-toolkit" class="nav-link" data-scroll-target="#diagnostic-toolkit">8.4 Diagnostic Toolkit</a></li>
  <li><a href="#spark-ui-ce-quil-faut-regarder" id="toc-spark-ui-ce-quil-faut-regarder" class="nav-link" data-scroll-target="#spark-ui-ce-quil-faut-regarder">8.5 Spark UI : Ce quâ€™il faut regarder</a></li>
  <li><a href="#debugging-oom" id="toc-debugging-oom" class="nav-link" data-scroll-target="#debugging-oom">8.6 Debugging OOM</a></li>
  </ul></li>
  <li><a href="#exercices-pratiques" id="toc-exercices-pratiques" class="nav-link" data-scroll-target="#exercices-pratiques">9. Exercices Pratiques</a>
  <ul class="collapse">
  <li><a href="#exercice-1-pratique-scala-adt-pipeline" id="toc-exercice-1-pratique-scala-adt-pipeline" class="nav-link" data-scroll-target="#exercice-1-pratique-scala-adt-pipeline">Exercice 1 : Pratique Scala â€” ADT Pipeline</a></li>
  <li><a href="#exercice-2-either-pour-etl" id="toc-exercice-2-either-pour-etl" class="nav-link" data-scroll-target="#exercice-2-either-pour-etl">Exercice 2 : Either pour ETL</a></li>
  <li><a href="#exercice-3-setup-almond-spark" id="toc-exercice-3-setup-almond-spark" class="nav-link" data-scroll-target="#exercice-3-setup-almond-spark">Exercice 3 : Setup Almond + Spark</a></li>
  <li><a href="#exercice-4-projet-intellij-complet" id="toc-exercice-4-projet-intellij-complet" class="nav-link" data-scroll-target="#exercice-4-projet-intellij-complet">Exercice 4 : Projet IntelliJ Complet</a></li>
  <li><a href="#exercice-5-diagnostiquer-un-job-lent" id="toc-exercice-5-diagnostiquer-un-job-lent" class="nav-link" data-scroll-target="#exercice-5-diagnostiquer-un-job-lent">Exercice 5 : Diagnostiquer un Job Lent</a></li>
  </ul></li>
  <li><a href="#mini-projet-etl-scala-bronze-silver-gold" id="toc-mini-projet-etl-scala-bronze-silver-gold" class="nav-link" data-scroll-target="#mini-projet-etl-scala-bronze-silver-gold">10. Mini-Projet : ETL Scala Bronze â†’ Silver â†’ Gold</a>
  <ul class="collapse">
  <li><a href="#objectif" id="toc-objectif" class="nav-link" data-scroll-target="#objectif">Objectif</a></li>
  <li><a href="#livrables" id="toc-livrables" class="nav-link" data-scroll-target="#livrables">Livrables</a></li>
  <li><a href="#donnÃ©es" id="toc-donnÃ©es" class="nav-link" data-scroll-target="#donnÃ©es">DonnÃ©es</a></li>
  <li><a href="#jobs-Ã -implÃ©menter" id="toc-jobs-Ã -implÃ©menter" class="nav-link" data-scroll-target="#jobs-Ã -implÃ©menter">Jobs Ã  implÃ©menter</a></li>
  </ul></li>
  <li><a href="#ressources" id="toc-ressources" class="nav-link" data-scroll-target="#ressources">ğŸ“š Ressources</a>
  <ul class="collapse">
  <li><a href="#documentation" id="toc-documentation" class="nav-link" data-scroll-target="#documentation">Documentation</a></li>
  <li><a href="#livres" id="toc-livres" class="nav-link" data-scroll-target="#livres">Livres</a></li>
  <li><a href="#outils" id="toc-outils" class="nav-link" data-scroll-target="#outils">Outils</a></li>
  </ul></li>
  <li><a href="#prochaine-Ã©tape" id="toc-prochaine-Ã©tape" class="nav-link" data-scroll-target="#prochaine-Ã©tape">â¡ï¸ Prochaine Ã©tape</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/diakite-data/data-engineering-bootcamp/blob/main/notebooks/advanced/30_spark_scala_deep_dive.ipynb" class="toc-action"><i class="bi bi-github"></i>Voir la source</a></li><li><a href="https://github.com/diakite-data/data-engineering-bootcamp/issues/new" class="toc-action"><i class="bi empty"></i>Faire part d'un problÃ¨me</a></li><li><a href="https://github.dev/diakite-data/data-engineering-bootcamp/blob/main/notebooks/advanced/30_spark_scala_deep_dive.ipynb" class="toc-action"><i class="bi empty"></i>Modifier cette page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">ğŸŸ¥ Niveau 3 : AvancÃ©</li><li class="breadcrumb-item"><a href="../../notebooks/advanced/30_spark_scala_deep_dive.html">âš¡ Processing AvancÃ©</a></li><li class="breadcrumb-item"><a href="../../notebooks/advanced/30_spark_scala_deep_dive.html">30 Â· Spark &amp; Scala Deep Dive</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">ğŸš€ Spark &amp; Scala Deep Dive</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Bienvenue dans ce module avancÃ© oÃ¹ tu vas maÃ®triser <strong>Scala pour Spark</strong> et comprendre les internals de Spark pour Ã©crire des jobs performants. Tu apprendras Ã  dÃ©velopper, builder et dÃ©ployer des applications Spark professionnelles.</p>
<hr>
<section id="prÃ©requis" class="level2">
<h2 class="anchored" data-anchor-id="prÃ©requis">PrÃ©requis</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Niveau</th>
<th>CompÃ©tence</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>âœ… Requis</td>
<td>PySpark DataFrame API (M19)</td>
</tr>
<tr class="even">
<td>âœ… Requis</td>
<td>Spark sur Kubernetes (M21)</td>
</tr>
<tr class="odd">
<td>âœ… Requis</td>
<td>Notions de programmation fonctionnelle</td>
</tr>
<tr class="even">
<td>ğŸ’¡ RecommandÃ©</td>
<td>ExpÃ©rience avec un IDE (VS Code, PyCharm)</td>
</tr>
</tbody>
</table>
</section>
<section id="objectifs-du-module" class="level2">
<h2 class="anchored" data-anchor-id="objectifs-du-module">ğŸ¯ Objectifs du module</h2>
<p>Ã€ la fin de ce module, tu seras capable de :</p>
<ul>
<li>Ã‰crire du code Scala idiomatique pour Spark</li>
<li>Utiliser les ADT (Algebraic Data Types) et Either/Try pour des pipelines robustes</li>
<li>Configurer un environnement de dÃ©veloppement complet (Notebook + IntelliJ)</li>
<li>Builder et dÃ©ployer des applications Spark avec sbt et spark-submit</li>
<li>Comprendre Catalyst, AQE et Tungsten pour optimiser tes jobs</li>
<li>Diagnostiquer et rÃ©soudre les problÃ¨mes de performance</li>
</ul>
<hr>
</section>
<section id="scala-pour-data-engineers" class="level2">
<h2 class="anchored" data-anchor-id="scala-pour-data-engineers">1. Scala pour Data Engineers</h2>
<section id="pourquoi-scala-pour-spark" class="level3">
<h3 class="anchored" data-anchor-id="pourquoi-scala-pour-spark">1.1 Pourquoi Scala pour Spark ?</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 30%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Aspect</th>
<th>Scala</th>
<th>Python</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Performance</strong></td>
<td>Natif JVM, pas de sÃ©rialisation</td>
<td>SÃ©rialisation Python â†”ï¸ JVM</td>
</tr>
<tr class="even">
<td><strong>Typage</strong></td>
<td>Statique, erreurs Ã  la compilation</td>
<td>Dynamique, erreurs au runtime</td>
</tr>
<tr class="odd">
<td><strong>API Spark</strong></td>
<td>API native, toutes les features</td>
<td>Wrapper, parfois en retard</td>
</tr>
<tr class="even">
<td><strong>Ã‰cosystÃ¨me</strong></td>
<td>Kafka, Flink, Akka</td>
<td>ML, Data Science</td>
</tr>
<tr class="odd">
<td><strong>Courbe dâ€™apprentissage</strong></td>
<td>Plus raide</td>
<td>Plus accessible</td>
</tr>
</tbody>
</table>
<p><strong>RÃ¨gle pratique</strong> : - <strong>Python</strong> : Exploration, prototypage, Data Science, petits pipelines - <strong>Scala</strong> : Production, gros volumes, performance critique, Ã©quipe backend Java/Scala</p>
</section>
<section id="syntaxe-essentielle" class="level3">
<h3 class="anchored" data-anchor-id="syntaxe-essentielle">1.2 Syntaxe Essentielle</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Variables : val (immutable) vs var (mutable)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> name<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">"Spark"</span>     <span class="co">// Immutable (prÃ©fÃ©rÃ©)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counter<span class="op">:</span> <span class="bu">Int</span> <span class="op">=</span> <span class="dv">0</span>           <span class="co">// Mutable (Ã  Ã©viter)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> inferred <span class="op">=</span> <span class="dv">42</span>              <span class="co">// Type infÃ©rÃ© automatiquement</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonctions</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonction classique</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">add</span><span class="op">(</span>a<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> b<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  a <span class="op">+</span> b</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonction one-liner (return implicite)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">multiply</span><span class="op">(</span>a<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span> b<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="bu">Int</span> <span class="op">=</span> a <span class="op">*</span> b</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonction anonyme (lambda)</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="dt">double</span> <span class="op">=</span> <span class="op">(</span>x<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span> <span class="op">=&gt;</span> x <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">// ParamÃ¨tres par dÃ©faut</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">greet</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> greeting<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">"Hello"</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="ss">s"$greeting</span><span class="st">, </span><span class="ss">$name</span><span class="st">!</span><span class="ss">"</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">greet</span><span class="op">(</span><span class="st">"Alice"</span><span class="op">)</span>              <span class="co">// "Hello, Alice!"</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">greet</span><span class="op">(</span><span class="st">"Bob"</span><span class="op">,</span> <span class="st">"Bonjour"</span><span class="op">)</span>     <span class="co">// "Bonjour, Bob!"</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">// String interpolation</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> version <span class="op">=</span> <span class="fl">3.5</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Spark version: </span><span class="ss">$version"</span><span class="op">)</span>           <span class="co">// Simple</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Next version: </span><span class="ss">${</span>version <span class="op">+</span> <span class="fl">0.1</span><span class="ss">}"</span><span class="op">)</span>    <span class="co">// Expression</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span><span class="ss">f"</span><span class="st">Pi = </span><span class="ss">${</span>math<span class="op">.</span>Pi<span class="ss">}</span><span class="st">%.2f</span><span class="ss">"</span><span class="op">)</span>               <span class="co">// FormatÃ©</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Conditions et boucles</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co">// if est une expression (retourne une valeur)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> status <span class="op">=</span> <span class="cf">if</span> <span class="op">(</span>counter <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="st">"positive"</span> <span class="cf">else</span> <span class="st">"zero or negative"</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co">// for-comprehension</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> squares <span class="op">=</span> <span class="cf">for</span> <span class="op">(</span>i <span class="op">&lt;-</span> <span class="dv">1</span> to <span class="dv">5</span><span class="op">)</span> <span class="cf">yield</span> i <span class="op">*</span> i  <span class="co">// Vector(1, 4, 9, 16, 25)</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co">// for avec filtres</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> evenSquares <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  i <span class="op">&lt;-</span> <span class="dv">1</span> to <span class="dv">10</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> i <span class="op">*</span> i  <span class="co">// Vector(4, 16, 36, 64, 100)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="collections-fonctionnelles" class="level3">
<h3 class="anchored" data-anchor-id="collections-fonctionnelles">1.3 Collections Fonctionnelles</h3>
<p>Les collections Scala sont la base pour comprendre les transformations Spark (RDD, DataFrame).</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Types de collections</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> list <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span>           <span class="co">// Immutable, linked list</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> vector <span class="op">=</span> <span class="ex">Vector</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span>       <span class="co">// Immutable, indexed</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> set <span class="op">=</span> <span class="ex">Set</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span>             <span class="co">// Immutable, unique: Set(1, 2, 3)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> map <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="st">"a"</span> <span class="op">-&gt;</span> <span class="dv">1</span><span class="op">,</span> <span class="st">"b"</span> <span class="op">-&gt;</span> <span class="dv">2</span><span class="op">)</span>        <span class="co">// Immutable, key-value</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Transformations (comme Spark !)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> numbers <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">// map : transformer chaque Ã©lÃ©ment</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">map</span><span class="op">(</span>x <span class="op">=&gt;</span> x <span class="op">*</span> <span class="dv">2</span><span class="op">)</span>              <span class="co">// List(2, 4, 6, 8, 10)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span>                   <span class="co">// Syntaxe courte</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">// filter : garder les Ã©lÃ©ments qui matchent</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>x <span class="op">=&gt;</span> x <span class="op">&gt;</span> <span class="dv">2</span><span class="op">)</span>           <span class="co">// List(3, 4, 5)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>_ <span class="op">&gt;</span> <span class="dv">2</span><span class="op">)</span>                <span class="co">// Syntaxe courte</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">// flatMap : map + flatten</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> words <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="st">"hello world"</span><span class="op">,</span> <span class="st">"scala spark"</span><span class="op">)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>words<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>_<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">" "</span><span class="op">))</span>          <span class="co">// List("hello", "world", "scala", "spark")</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">// reduce : agrÃ©ger en une valeur</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">reduce</span><span class="op">((</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">=&gt;</span> a <span class="op">+</span> b<span class="op">)</span>      <span class="co">// 15</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">reduce</span><span class="op">(</span>_ <span class="op">+</span> _<span class="op">)</span>                <span class="co">// Syntaxe courte</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co">// fold : reduce avec valeur initiale</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">fold</span><span class="op">(</span><span class="dv">0</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span>               <span class="co">// 15</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>numbers<span class="op">.</span><span class="fu">fold</span><span class="op">(</span><span class="dv">10</span><span class="op">)(</span>_ <span class="op">+</span> _<span class="op">)</span>              <span class="co">// 25 (commence Ã  10)</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co">// ChaÃ®nage (comme les pipelines Spark)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result <span class="op">=</span> numbers</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>_ <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span>    <span class="co">// Garder les pairs</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> <span class="dv">10</span><span class="op">)</span>           <span class="co">// Multiplier par 10</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>sum                   <span class="co">// Sommer : 60 (20 + 40)</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="co">// groupBy (comme Spark groupBy !)</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Sale</span><span class="op">(</span>product<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> amount<span class="op">:</span> <span class="ex">Double</span><span class="op">)</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sales <span class="op">=</span> <span class="ex">List</span><span class="op">(</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sale</span><span class="op">(</span><span class="st">"laptop"</span><span class="op">,</span> <span class="dv">1000</span><span class="op">),</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sale</span><span class="op">(</span><span class="st">"phone"</span><span class="op">,</span> <span class="dv">500</span><span class="op">),</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sale</span><span class="op">(</span><span class="st">"laptop"</span><span class="op">,</span> <span class="dv">1200</span><span class="op">),</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sale</span><span class="op">(</span><span class="st">"phone"</span><span class="op">,</span> <span class="dv">600</span><span class="op">)</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> byProduct <span class="op">=</span> sales<span class="op">.</span><span class="fu">groupBy</span><span class="op">(</span>_<span class="op">.</span>product<span class="op">)</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Map(</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">//   "laptop" -&gt; List(Sale("laptop", 1000), Sale("laptop", 1200)),</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co">//   "phone"  -&gt; List(Sale("phone", 500), Sale("phone", 600))</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co">// )</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> totalByProduct <span class="op">=</span> sales</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">groupBy</span><span class="op">(</span>_<span class="op">.</span>product<span class="op">)</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>map <span class="op">{</span> <span class="cf">case</span> <span class="op">(</span>product<span class="op">,</span> sales<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>product<span class="op">,</span> sales<span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>amount<span class="op">).</span>sum<span class="op">)</span> </span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co">// Map("laptop" -&gt; 2200.0, "phone" -&gt; 1100.0)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="option-gÃ©rer-les-valeurs-absentes" class="level3">
<h3 class="anchored" data-anchor-id="option-gÃ©rer-les-valeurs-absentes">1.4 Option : GÃ©rer les valeurs absentes</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Option = Some(valeur) ou None (jamais null !)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">findUser</span><span class="op">(</span>id<span class="op">:</span> <span class="bu">Int</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> users <span class="op">=</span> <span class="ex">Map</span><span class="op">(</span><span class="dv">1</span> <span class="op">-&gt;</span> <span class="st">"Alice"</span><span class="op">,</span> <span class="dv">2</span> <span class="op">-&gt;</span> <span class="st">"Bob"</span><span class="op">)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  users<span class="op">.</span><span class="fu">get</span><span class="op">(</span>id<span class="op">)</span>  <span class="co">// Retourne Option[String]</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">findUser</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span>  <span class="co">// Some("Alice")</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">findUser</span><span class="op">(</span><span class="dv">99</span><span class="op">)</span> <span class="co">// None</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern matching</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">findUser</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">Some</span><span class="op">(</span>name<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Found: </span><span class="ss">$name"</span><span class="op">)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="bu">None</span>       <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="st">"User not found"</span><span class="op">)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">// getOrElse : valeur par dÃ©faut</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> user <span class="op">=</span> <span class="fu">findUser</span><span class="op">(</span><span class="dv">99</span><span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="st">"Unknown"</span><span class="op">)</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">// map sur Option (sÃ»r, pas d'exception)</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> upperName <span class="op">=</span> <span class="fu">findUser</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>toUpperCase<span class="op">)</span>  <span class="co">// Some("ALICE")</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> noName <span class="op">=</span> <span class="fu">findUser</span><span class="op">(</span><span class="dv">99</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>toUpperCase<span class="op">)</span>    <span class="co">// None (pas d'erreur !)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">// flatMap pour chaÃ®ner</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">findEmail</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> <span class="ex">Option</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>name <span class="op">==</span> <span class="st">"Alice"</span><span class="op">)</span> <span class="bu">Some</span><span class="op">(</span><span class="st">"alice@example.com"</span><span class="op">)</span> <span class="cf">else</span> <span class="bu">None</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> email <span class="op">=</span> <span class="fu">findUser</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">flatMap</span><span class="op">(</span>findEmail<span class="op">)</span>  <span class="co">// Some("alice@example.com")</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="case-classes-et-pattern-matching" class="level3">
<h3 class="anchored" data-anchor-id="case-classes-et-pattern-matching">1.5 Case Classes et Pattern Matching</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Case Class = classe de donnÃ©es immuable</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Customer</span><span class="op">(</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  id<span class="op">:</span> <span class="ex">Long</span><span class="op">,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  name<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  email<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  country<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">"France"</span>  <span class="co">// Valeur par dÃ©faut</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">// CrÃ©ation (pas besoin de "new")</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> alice <span class="op">=</span> <span class="fu">Customer</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">"Alice"</span><span class="op">,</span> <span class="st">"alice@example.com"</span><span class="op">)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> bob <span class="op">=</span> <span class="fu">Customer</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="st">"Bob"</span><span class="op">,</span> <span class="st">"bob@example.com"</span><span class="op">,</span> <span class="st">"USA"</span><span class="op">)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Accesseurs automatiques</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span>alice<span class="op">.</span>name<span class="op">)</span>    <span class="co">// "Alice"</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span>alice<span class="op">.</span>country<span class="op">)</span> <span class="co">// "France"</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">// equals automatique (compare les valeurs)</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> alice2 <span class="op">=</span> <span class="fu">Customer</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">"Alice"</span><span class="op">,</span> <span class="st">"alice@example.com"</span><span class="op">)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span>alice <span class="op">==</span> alice2<span class="op">)</span>  <span class="co">// true !</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">// copy : crÃ©er une copie modifiÃ©e (immutabilitÃ©)</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> aliceUSA <span class="op">=</span> alice<span class="op">.</span><span class="fu">copy</span><span class="op">(</span>country <span class="op">=</span> <span class="st">"USA"</span><span class="op">)</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">// toString automatique</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span>alice<span class="op">)</span>  <span class="co">// Customer(1,Alice,alice@example.com,France)</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern Matching (switch++ ultra puissant)</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">describeCustomer</span><span class="op">(</span>c<span class="op">:</span> Customer<span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> c <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Customer</span><span class="op">(</span>_<span class="op">,</span> <span class="st">"Alice"</span><span class="op">,</span> _<span class="op">,</span> _<span class="op">)</span>     <span class="op">=&gt;</span> <span class="st">"C'est Alice !"</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Customer</span><span class="op">(</span>id<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> <span class="st">"France"</span><span class="op">)</span>   <span class="op">=&gt;</span> <span class="ss">s"</span><span class="st">Client franÃ§ais #</span><span class="ss">$id"</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Customer</span><span class="op">(</span>_<span class="op">,</span> name<span class="op">,</span> _<span class="op">,</span> country<span class="op">)</span>  <span class="op">=&gt;</span> <span class="ss">s"$name</span><span class="st"> de </span><span class="ss">$country"</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern matching avec guards</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">customerTier</span><span class="op">(</span>c<span class="op">:</span> Customer<span class="op">,</span> totalSpent<span class="op">:</span> <span class="ex">Double</span><span class="op">):</span> <span class="ex">String</span> <span class="op">=</span> c <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Customer</span><span class="op">(</span>_<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> <span class="st">"France"</span><span class="op">)</span> <span class="cf">if</span> totalSpent <span class="op">&gt;</span> <span class="dv">10000</span> <span class="op">=&gt;</span> <span class="st">"VIP France"</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _ <span class="cf">if</span> totalSpent <span class="op">&gt;</span> <span class="dv">5000</span>                             <span class="op">=&gt;</span> <span class="st">"Gold"</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _                                                  <span class="op">=&gt;</span> <span class="st">"Standard"</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co">// Case classes et Spark</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Spark utilise les case classes pour crÃ©er des Datasets typÃ©s !</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> spark<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Sale</span><span class="op">(</span>product<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> amount<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span> date<span class="op">:</span> <span class="ex">String</span><span class="op">)</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sales <span class="op">=</span> <span class="bu">Seq</span><span class="op">(</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sale</span><span class="op">(</span><span class="st">"laptop"</span><span class="op">,</span> <span class="dv">1000</span><span class="op">,</span> <span class="st">"2024-01-15"</span><span class="op">),</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sale</span><span class="op">(</span><span class="st">"phone"</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="st">"2024-01-16"</span><span class="op">)</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">toDS</span><span class="op">()</span>  <span class="co">// Dataset[Sale] - typÃ© !</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="co">// AccÃ¨s typÃ©</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>sales<span class="op">.</span><span class="fu">filter</span><span class="op">(</span>_<span class="op">.</span>amount <span class="op">&gt;</span> <span class="dv">600</span><span class="op">).</span><span class="fu">show</span><span class="op">()</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sealed-traits-et-adt-algebraic-data-types" class="level3">
<h3 class="anchored" data-anchor-id="sealed-traits-et-adt-algebraic-data-types">1.6 Sealed Traits et ADT (Algebraic Data Types) ğŸ”¥</h3>
<p>Les <strong>ADT</strong> permettent de modÃ©liser tous les Ã©tats possibles dâ€™un systÃ¨me. Le compilateur garantit lâ€™exhaustivitÃ© !</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">// sealed trait = toutes les sous-classes dans le mÃªme fichier</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Le compilateur CONNAÃT tous les cas possibles</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ModÃ©liser le rÃ©sultat d'un job ETL</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> JobResult</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Success</span><span class="op">(</span>recordsProcessed<span class="op">:</span> <span class="ex">Long</span><span class="op">,</span> durationMs<span class="op">:</span> <span class="ex">Long</span><span class="op">)</span> <span class="kw">extends</span> JobResult</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Failure</span><span class="op">(</span>error<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> stage<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> JobResult</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Skipped <span class="kw">extends</span> JobResult  <span class="co">// object = singleton</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">handleResult</span><span class="op">(</span>result<span class="op">:</span> JobResult<span class="op">):</span> <span class="bu">Unit</span> <span class="op">=</span> result <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Success</span><span class="op">(</span>n<span class="op">,</span> d<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âœ… </span><span class="ss">$n</span><span class="st"> records traitÃ©s en </span><span class="ss">${</span>d<span class="ss">}</span><span class="st">ms</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Failure</span><span class="op">(</span>e<span class="op">,</span> s<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Erreur Ã  l'Ã©tape </span><span class="ss">$s</span><span class="st">: </span><span class="ss">$e"</span><span class="op">)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Skipped       <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">â­ï¸ Job ignorÃ©</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Si tu oublies un cas, le compilateur te PRÃ‰VIENT !</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Exemple : Sources de donnÃ©es</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> <span class="ex">DataSource</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">JdbcSource</span><span class="op">(</span>url<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> table<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> user<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">DataSource</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">S3Source</span><span class="op">(</span>bucket<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> path<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> format<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">DataSource</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">KafkaSource</span><span class="op">(</span>brokers<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> topic<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">DataSource</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">LocalSource</span><span class="op">(</span>path<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> <span class="ex">DataSource</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">readData</span><span class="op">(</span>source<span class="op">:</span> <span class="ex">DataSource</span><span class="op">)(</span><span class="kw">implicit</span> spark<span class="op">:</span> SparkSession<span class="op">):</span> DataFrame <span class="op">=</span> source <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">JdbcSource</span><span class="op">(</span>url<span class="op">,</span> table<span class="op">,</span> user<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    spark<span class="op">.</span>read</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"jdbc"</span><span class="op">)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"url"</span><span class="op">,</span> url<span class="op">)</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"dbtable"</span><span class="op">,</span> table<span class="op">)</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"user"</span><span class="op">,</span> user<span class="op">)</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">load</span><span class="op">()</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">S3Source</span><span class="op">(</span>bucket<span class="op">,</span> path<span class="op">,</span> format<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    spark<span class="op">.</span>read</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">format</span><span class="op">(</span>format<span class="op">)</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">load</span><span class="op">(</span><span class="ss">s"</span><span class="st">s3a://</span><span class="ss">$bucket</span><span class="st">/</span><span class="ss">$path"</span><span class="op">)</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">KafkaSource</span><span class="op">(</span>brokers<span class="op">,</span> topic<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    spark<span class="op">.</span>read</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"kafka"</span><span class="op">)</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"kafka.bootstrap.servers"</span><span class="op">,</span> brokers<span class="op">)</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"subscribe"</span><span class="op">,</span> topic<span class="op">)</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">load</span><span class="op">()</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">LocalSource</span><span class="op">(</span>path<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    spark<span class="op">.</span>read<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span>path<span class="op">)</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Exemple : Modes de traitement</span></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> WriteMode</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Overwrite <span class="kw">extends</span> WriteMode</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Append <span class="kw">extends</span> WriteMode</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">MergeByKey</span><span class="op">(</span>keys<span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span><span class="ex">String</span><span class="op">])</span> <span class="kw">extends</span> WriteMode</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">writeData</span><span class="op">(</span>df<span class="op">:</span> DataFrame<span class="op">,</span> path<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> mode<span class="op">:</span> WriteMode<span class="op">):</span> <span class="bu">Unit</span> <span class="op">=</span> mode <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Overwrite       <span class="op">=&gt;</span> df<span class="op">.</span>write<span class="op">.</span><span class="fu">mode</span><span class="op">(</span><span class="st">"overwrite"</span><span class="op">).</span><span class="fu">parquet</span><span class="op">(</span>path<span class="op">)</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> Append          <span class="op">=&gt;</span> df<span class="op">.</span>write<span class="op">.</span><span class="fu">mode</span><span class="op">(</span><span class="st">"append"</span><span class="op">).</span><span class="fu">parquet</span><span class="op">(</span>path<span class="op">)</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">MergeByKey</span><span class="op">(</span>keys<span class="op">)</span> <span class="op">=&gt;</span> </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Logique Delta Lake MERGE</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Merge on keys: </span><span class="ss">${</span>keys<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">", "</span><span class="op">)</span><span class="ss">}"</span><span class="op">)</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="gestion-derreurs-either-et-try" class="level3">
<h3 class="anchored" data-anchor-id="gestion-derreurs-either-et-try">1.7 Gestion dâ€™Erreurs : Either et Try ğŸ”¥</h3>
<p>Fini les <code>try/catch</code> partout ! Scala offre des types pour gÃ©rer les erreurs proprement.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Try[T] : capturer les exceptions (code legacy, I/O)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> scala<span class="op">.</span>util<span class="op">.{</span>Try<span class="op">,</span> Success<span class="op">,</span> Failure<span class="op">}</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">parseNumber</span><span class="op">(</span>s<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Try<span class="op">[</span><span class="bu">Int</span><span class="op">]</span> <span class="op">=</span> Try <span class="op">{</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  s<span class="op">.</span>toInt  <span class="co">// Peut lancer NumberFormatException</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">parseNumber</span><span class="op">(</span><span class="st">"42"</span><span class="op">)</span>   <span class="co">// Success(42)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="fu">parseNumber</span><span class="op">(</span><span class="st">"abc"</span><span class="op">)</span>  <span class="co">// Failure(NumberFormatException)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern matching</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="fu">parseNumber</span><span class="op">(</span><span class="st">"42"</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Success</span><span class="op">(</span>n<span class="op">)</span>  <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Nombre: </span><span class="ss">$n"</span><span class="op">)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Failure</span><span class="op">(</span>ex<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Erreur: </span><span class="ss">${</span>ex<span class="op">.</span>getMessage<span class="ss">}"</span><span class="op">)</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">// getOrElse</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> num <span class="op">=</span> <span class="fu">parseNumber</span><span class="op">(</span><span class="st">"abc"</span><span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span>  <span class="co">// 0</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">// map / flatMap (chaÃ®nage sÃ»r)</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> doubled <span class="op">=</span> <span class="fu">parseNumber</span><span class="op">(</span><span class="st">"21"</span><span class="op">).</span><span class="fu">map</span><span class="op">(</span>_ <span class="op">*</span> <span class="dv">2</span><span class="op">)</span>  <span class="co">// Success(42)</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co">// recover : transformer l'erreur</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> safe <span class="op">=</span> <span class="fu">parseNumber</span><span class="op">(</span><span class="st">"abc"</span><span class="op">).</span>recover <span class="op">{</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _<span class="op">:</span> <span class="ex">NumberFormatException</span> <span class="op">=&gt;</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>  <span class="co">// Success(-1)</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Either[L, R] : erreurs mÃ©tier typÃ©es (pas d'exceptions)</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Left = erreur, Right = succÃ¨s</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">// DÃ©finir les types d'erreurs</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> ETLError</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">SourceNotFound</span><span class="op">(</span>path<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">SchemaError</span><span class="op">(</span>expected<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> actual<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">WriteError</span><span class="op">(</span>message<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">ConfigError</span><span class="op">(</span>param<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Fonctions qui retournent Either</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">readSource</span><span class="op">(</span>path<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> DataFrame<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span><span class="kw">new</span> java<span class="op">.</span>io<span class="op">.</span><span class="ex">File</span><span class="op">(</span>path<span class="op">).</span><span class="fu">exists</span><span class="op">())</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Left</span><span class="op">(</span><span class="fu">SourceNotFound</span><span class="op">(</span>path<span class="op">))</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Right</span><span class="op">(</span>spark<span class="op">.</span>read<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span>path<span class="op">))</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">validateSchema</span><span class="op">(</span>df<span class="op">:</span> DataFrame<span class="op">,</span> expected<span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> DataFrame<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">val</span> actual <span class="op">=</span> df<span class="op">.</span>columns<span class="op">.</span>toSeq</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>expected<span class="op">.</span><span class="fu">forall</span><span class="op">(</span>actual<span class="op">.</span>contains<span class="op">))</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Right</span><span class="op">(</span>df<span class="op">)</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Left</span><span class="op">(</span><span class="fu">SchemaError</span><span class="op">(</span>expected<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">","</span><span class="op">),</span> actual<span class="op">.</span><span class="fu">mkString</span><span class="op">(</span><span class="st">","</span><span class="op">)))</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">writeOutput</span><span class="op">(</span>df<span class="op">:</span> DataFrame<span class="op">,</span> path<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> <span class="ex">Long</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    df<span class="op">.</span>write<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span>path<span class="op">)</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Right</span><span class="op">(</span>df<span class="op">.</span><span class="fu">count</span><span class="op">())</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> e<span class="op">:</span> <span class="ex">Exception</span> <span class="op">=&gt;</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">WriteError</span><span class="op">(</span>e<span class="op">.</span>getMessage<span class="op">))</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a><span class="co">// ChaÃ®nage avec for-comprehension (le pattern ultime !)</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">runETL</span><span class="op">(</span>inputPath<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> outputPath<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> <span class="ex">Long</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    rawData      <span class="op">&lt;-</span> <span class="fu">readSource</span><span class="op">(</span>inputPath<span class="op">)</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    validated    <span class="op">&lt;-</span> <span class="fu">validateSchema</span><span class="op">(</span>rawData<span class="op">,</span> <span class="bu">Seq</span><span class="op">(</span><span class="st">"id"</span><span class="op">,</span> <span class="st">"name"</span><span class="op">,</span> <span class="st">"amount"</span><span class="op">))</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    transformed  <span class="op">=</span> validated<span class="op">.</span><span class="fu">filter</span><span class="op">(</span><span class="fu">col</span><span class="op">(</span><span class="st">"amount"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span>  <span class="co">// = pour les transformations pures</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    recordCount  <span class="op">&lt;-</span> <span class="fu">writeOutput</span><span class="op">(</span>transformed<span class="op">,</span> outputPath<span class="op">)</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> recordCount</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span class="co">// Utilisation</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="fu">runETL</span><span class="op">(</span><span class="st">"data/input"</span><span class="op">,</span> <span class="st">"data/output"</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Right</span><span class="op">(</span>count<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âœ… ETL terminÃ© : </span><span class="ss">$count</span><span class="st"> records</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">SourceNotFound</span><span class="op">(</span>p<span class="op">))</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Source introuvable : </span><span class="ss">$p"</span><span class="op">)</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">SchemaError</span><span class="op">(</span>e<span class="op">,</span> a<span class="op">))</span> <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ SchÃ©ma invalide. Attendu: </span><span class="ss">$e</span><span class="st">, ReÃ§u: </span><span class="ss">$a"</span><span class="op">)</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">WriteError</span><span class="op">(</span>msg<span class="op">))</span>   <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Erreur d'Ã©criture : </span><span class="ss">$msg"</span><span class="op">)</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">ConfigError</span><span class="op">(</span>p<span class="op">))</span>    <span class="op">=&gt;</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Config manquante : </span><span class="ss">$p"</span><span class="op">)</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Quand utiliser quoi ?</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Outil</th>
<th>Quand lâ€™utiliser</th>
<th>Exemple</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Option[T]</strong></td>
<td>Valeur absente (pas une erreur)</td>
<td><code>findUser(id)</code></td>
</tr>
<tr class="even">
<td><strong>Try[T]</strong></td>
<td>Exceptions Java/legacy, I/O</td>
<td><code>Try { file.read() }</code></td>
</tr>
<tr class="odd">
<td><strong>Either[E, T]</strong></td>
<td>Erreurs mÃ©tier typÃ©es</td>
<td>Pipeline ETL, validation</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="environnements-de-dÃ©veloppement" class="level2">
<h2 class="anchored" data-anchor-id="environnements-de-dÃ©veloppement">2. Environnements de DÃ©veloppement</h2>
<section id="scala-dans-jupyter-notebook-avec-almond" class="level3">
<h3 class="anchored" data-anchor-id="scala-dans-jupyter-notebook-avec-almond">2.1 Scala dans Jupyter Notebook avec Almond</h3>
<p><strong>Almond</strong> est un kernel Scala pour Jupyter, idÃ©al pour lâ€™exploration et la formation.</p>
<section id="installation" class="level4">
<h4 class="anchored" data-anchor-id="installation">Installation</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Installer Coursier (gestionnaire de packages Scala)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-fL</span> https://github.com/coursier/coursier/releases/latest/download/cs-x86_64-pc-linux.gz <span class="kw">|</span> <span class="fu">gzip</span> <span class="at">-d</span> <span class="op">&gt;</span> cs</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x cs</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./cs</span> setup  <span class="co"># Ajoute au PATH</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Installer Almond</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">cs</span> launch <span class="at">--fork</span> almond <span class="at">--</span> <span class="at">--install</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. VÃ©rifier</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ex">jupyter</span> kernelspec list</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Devrait afficher : scala  /home/user/.local/share/jupyter/kernels/scala</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Lancer Jupyter</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ex">jupyter</span> notebook</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># â†’ Nouveau notebook â†’ Kernel "Scala"</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="configuration-spark-dans-almond" class="level4">
<h4 class="anchored" data-anchor-id="configuration-spark-dans-almond">Configuration Spark dans Almond</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Dans une cellule du notebook Scala</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Importer les dÃ©pendances avec Ammonite</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> $ivy<span class="op">.</span>`org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">::</span>spark<span class="op">-</span>sql<span class="op">:</span><span class="dv">3</span><span class="op">.</span><span class="fl">5.0</span>`</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> $ivy<span class="op">.</span>`io<span class="op">.</span>delta<span class="op">::</span>delta<span class="op">-</span>spark<span class="op">:</span><span class="dv">3</span><span class="op">.</span><span class="fl">1.0</span>`</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">// CrÃ©er la SparkSession</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.</span>SparkSession</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> spark <span class="op">=</span> SparkSession<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">appName</span><span class="op">(</span><span class="st">"Almond Spark"</span><span class="op">)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">master</span><span class="op">(</span><span class="st">"local[*]"</span><span class="op">)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">config</span><span class="op">(</span><span class="st">"spark.sql.extensions"</span><span class="op">,</span> <span class="st">"io.delta.sql.DeltaSparkSessionExtension"</span><span class="op">)</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">config</span><span class="op">(</span><span class="st">"spark.sql.catalog.spark_catalog"</span><span class="op">,</span> <span class="st">"org.apache.spark.sql.delta.catalog.DeltaCatalog"</span><span class="op">)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">getOrCreate</span><span class="op">()</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> spark<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Test</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df <span class="op">=</span> <span class="bu">Seq</span><span class="op">((</span><span class="dv">1</span><span class="op">,</span> <span class="st">"Alice"</span><span class="op">),</span> <span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="st">"Bob"</span><span class="op">)).</span><span class="fu">toDF</span><span class="op">(</span><span class="st">"id"</span><span class="op">,</span> <span class="st">"name"</span><span class="op">)</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">show</span><span class="op">()</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="alternatives" class="level4">
<h4 class="anchored" data-anchor-id="alternatives">Alternatives</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Kernel</th>
<th>Avantages</th>
<th>InconvÃ©nients</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Almond</strong></td>
<td>Moderne, Ammonite, bien maintenu</td>
<td>Setup manuel</td>
</tr>
<tr class="even">
<td><strong>spylon-kernel</strong></td>
<td>Simple, pip install</td>
<td>Moins de features</td>
</tr>
<tr class="odd">
<td><strong>Apache Toree</strong></td>
<td>Officiel Apache Spark</td>
<td>Plus lourd, moins actif</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="intellij-idea" class="level3">
<h3 class="anchored" data-anchor-id="intellij-idea">2.2 IntelliJ IDEA</h3>
<p>Pour les projets de production, <strong>IntelliJ IDEA</strong> est lâ€™IDE de rÃ©fÃ©rence pour Scala.</p>
<section id="installation-1" class="level4">
<h4 class="anchored" data-anchor-id="installation-1">Installation</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. TÃ©lÃ©charger IntelliJ IDEA Community Edition (gratuit)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://www.jetbrains.com/idea/download/</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Linux : extraire et lancer</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> ideaIC-<span class="pp">*</span>.tar.gz</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> idea-IC-<span class="pp">*</span>/bin</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ex">./idea.sh</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Installer le plugin Scala</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># File â†’ Settings â†’ Plugins â†’ Marketplace â†’ Rechercher "Scala" â†’ Install</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Configurer le JDK</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># File â†’ Project Structure â†’ SDKs â†’ + â†’ Download JDK â†’ Version 11 ou 17</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="quand-utiliser-quoi" class="level3">
<h3 class="anchored" data-anchor-id="quand-utiliser-quoi">2.3 Quand utiliser quoi ?</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 60%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>Environnement</th>
<th>Use case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Notebook (Almond)</strong></td>
<td>Exploration, prototypage, formation, dÃ©mos</td>
</tr>
<tr class="even">
<td><strong>IntelliJ + sbt</strong></td>
<td>DÃ©veloppement, tests, refactoring, projets production</td>
</tr>
<tr class="odd">
<td><strong>spark-submit</strong></td>
<td>ExÃ©cution sur cluster (YARN, K8s)</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="projet-complet-avec-intellij-step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="projet-complet-avec-intellij-step-by-step">3. Projet Complet avec IntelliJ (Step-by-Step)</h2>
<p>On va crÃ©er un projet Spark/Scala complet de A Ã  Z.</p>
<section id="crÃ©er-le-projet" class="level3">
<h3 class="anchored" data-anchor-id="crÃ©er-le-projet">3.1 CrÃ©er le projet</h3>
<ol type="1">
<li><strong>File â†’ New â†’ Project</strong></li>
<li>SÃ©lectionner <strong>sbt</strong> (Ã  gauche)</li>
<li>Configurer :
<ul>
<li>Name : <code>spark-etl-project</code></li>
<li>Location : <code>/home/user/projects/spark-etl-project</code></li>
<li>JDK : 11 ou 17</li>
<li>sbt version : 1.9.x</li>
<li>Scala version : <strong>2.12.18</strong> (compatible Spark 3.5)</li>
</ul></li>
<li><strong>Create</strong></li>
</ol>
</section>
<section id="structure-du-projet" class="level3">
<h3 class="anchored" data-anchor-id="structure-du-projet">3.2 Structure du projet</h3>
<pre class="text"><code>spark-etl-project/
â”œâ”€â”€ build.sbt                      # DÃ©pendances et config
â”œâ”€â”€ project/
â”‚   â”œâ”€â”€ build.properties           # Version sbt
â”‚   â””â”€â”€ plugins.sbt                # Plugins (sbt-assembly)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ scala/
â”‚   â”‚   â”‚   â””â”€â”€ com/
â”‚   â”‚   â”‚       â””â”€â”€ example/
â”‚   â”‚   â”‚           â”œâ”€â”€ Main.scala
â”‚   â”‚   â”‚           â”œâ”€â”€ config/
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ AppConfig.scala
â”‚   â”‚   â”‚           â”œâ”€â”€ jobs/
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ SalesETL.scala
â”‚   â”‚   â”‚           â”œâ”€â”€ models/
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ Models.scala
â”‚   â”‚   â”‚           â””â”€â”€ utils/
â”‚   â”‚   â”‚               â””â”€â”€ SparkSessionWrapper.scala
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.conf
â”‚   â”‚       â””â”€â”€ log4j2.properties
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ scala/
â”‚           â””â”€â”€ com/
â”‚               â””â”€â”€ example/
â”‚                   â””â”€â”€ jobs/
â”‚                       â””â”€â”€ SalesETLSpec.scala
â”œâ”€â”€ data/
â”‚   â””â”€â”€ input/
â”‚       â””â”€â”€ sales.csv
â””â”€â”€ output/                        # GÃ©nÃ©rÃ©</code></pre>
</section>
<section id="fichiers-de-configuration" class="level3">
<h3 class="anchored" data-anchor-id="fichiers-de-configuration">3.3 Fichiers de configuration</h3>
<p><strong><code>build.sbt</code></strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>name <span class="op">:=</span> <span class="st">"spark-etl-project"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>version <span class="op">:=</span> <span class="st">"1.0.0"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>scalaVersion <span class="op">:=</span> <span class="st">"2.12.18"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Spark 3.5 (provided = dÃ©jÃ  sur le cluster)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sparkVersion <span class="op">=</span> <span class="st">"3.5.0"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>libraryDependencies <span class="op">++=</span> <span class="bu">Seq</span><span class="op">(</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Spark (provided pour le cluster, compile pour local)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"org.apache.spark"</span> <span class="op">%%</span> <span class="st">"spark-sql"</span>  <span class="op">%</span> sparkVersion <span class="op">%</span> <span class="st">"provided"</span><span class="op">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"org.apache.spark"</span> <span class="op">%%</span> <span class="st">"spark-core"</span> <span class="op">%</span> sparkVersion <span class="op">%</span> <span class="st">"provided"</span><span class="op">,</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Delta Lake</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"io.delta"</span> <span class="op">%%</span> <span class="st">"delta-spark"</span> <span class="op">%</span> <span class="st">"3.1.0"</span><span class="op">,</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Config</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"com.typesafe"</span> <span class="op">%</span> <span class="st">"config"</span> <span class="op">%</span> <span class="st">"1.4.3"</span><span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Tests</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"org.scalatest"</span> <span class="op">%%</span> <span class="st">"scalatest"</span> <span class="op">%</span> <span class="st">"3.2.17"</span> <span class="op">%</span> Test</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Pour exÃ©cuter en local dans IntelliJ (override provided)</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>Compile <span class="op">/</span> run <span class="op">:=</span> Defaults<span class="op">.</span><span class="fu">runTask</span><span class="op">(</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  Compile <span class="op">/</span> fullClasspath<span class="op">,</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  Compile <span class="op">/</span> run <span class="op">/</span> mainClass<span class="op">,</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  Compile <span class="op">/</span> run <span class="op">/</span> runner</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="op">).</span>evaluated</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Assembly config (fat JAR)</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>assembly <span class="op">/</span> assemblyMergeStrategy <span class="op">:=</span> <span class="op">{</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="fu">PathList</span><span class="op">(</span><span class="st">"META-INF"</span><span class="op">,</span> xs @ _<span class="op">*)</span> <span class="op">=&gt;</span> MergeStrategy<span class="op">.</span>discard</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="st">"reference.conf"</span>              <span class="op">=&gt;</span> MergeStrategy<span class="op">.</span>concat</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> x                              <span class="op">=&gt;</span> MergeStrategy<span class="op">.</span>first</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>assembly <span class="op">/</span> assemblyJarName <span class="op">:=</span> <span class="ss">s"${</span>name<span class="op">.</span>value<span class="ss">}</span><span class="st">-</span><span class="ss">${</span>version<span class="op">.</span>value<span class="ss">}</span><span class="st">.jar</span><span class="ss">"</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong><code>project/build.properties</code></strong> :</p>
<pre class="properties"><code>sbt.version=1.9.8</code></pre>
<p><strong><code>project/plugins.sbt</code></strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">addSbtPlugin</span><span class="op">(</span><span class="st">"com.eed3si9n"</span> <span class="op">%</span> <span class="st">"sbt-assembly"</span> <span class="op">%</span> <span class="st">"2.1.5"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="code-scala" class="level3">
<h3 class="anchored" data-anchor-id="code-scala">3.4 Code Scala</h3>
<p><strong><code>src/main/scala/com/example/utils/SparkSessionWrapper.scala</code></strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> com<span class="op">.</span>example<span class="op">.</span>utils</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.</span>SparkSession</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">trait</span> SparkSessionWrapper <span class="op">{</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">lazy</span> <span class="kw">val</span> spark<span class="op">:</span> SparkSession <span class="op">=</span> SparkSession<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">appName</span><span class="op">(</span><span class="st">"SparkETL"</span><span class="op">)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">master</span><span class="op">(</span>sys<span class="op">.</span>env<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span><span class="st">"SPARK_MASTER"</span><span class="op">,</span> <span class="st">"local[*]"</span><span class="op">))</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">config</span><span class="op">(</span><span class="st">"spark.sql.extensions"</span><span class="op">,</span> <span class="st">"io.delta.sql.DeltaSparkSessionExtension"</span><span class="op">)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">config</span><span class="op">(</span><span class="st">"spark.sql.catalog.spark_catalog"</span><span class="op">,</span> </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"org.apache.spark.sql.delta.catalog.DeltaCatalog"</span><span class="op">)</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">config</span><span class="op">(</span><span class="st">"spark.sql.adaptive.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">config</span><span class="op">(</span><span class="st">"spark.sql.adaptive.coalescePartitions.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getOrCreate</span><span class="op">()</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// RÃ©duire les logs Spark</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  spark<span class="op">.</span>sparkContext<span class="op">.</span><span class="fu">setLogLevel</span><span class="op">(</span><span class="st">"WARN"</span><span class="op">)</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong><code>src/main/scala/com/example/models/Models.scala</code></strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> com<span class="op">.</span>example<span class="op">.</span>models</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ModÃ¨les de donnÃ©es (case classes)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Sale</span><span class="op">(</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  transactionId<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  productCategory<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  amount<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  quantity<span class="op">:</span> <span class="bu">Int</span><span class="op">,</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  date<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  customerId<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">SalesSummary</span><span class="op">(</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  productCategory<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  totalSales<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  totalQuantity<span class="op">:</span> <span class="ex">Long</span><span class="op">,</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  avgSale<span class="op">:</span> <span class="ex">Double</span><span class="op">,</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  transactionCount<span class="op">:</span> <span class="ex">Long</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="co">// ADT pour les rÃ©sultats de job</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> JobResult</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">JobSuccess</span><span class="op">(</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  recordsRead<span class="op">:</span> <span class="ex">Long</span><span class="op">,</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  recordsWritten<span class="op">:</span> <span class="ex">Long</span><span class="op">,</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  durationMs<span class="op">:</span> <span class="ex">Long</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="kw">extends</span> JobResult</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">JobFailure</span><span class="op">(</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>  stage<span class="op">:</span> <span class="ex">String</span><span class="op">,</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  error<span class="op">:</span> <span class="ex">String</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="kw">extends</span> JobResult</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="co">// ADT pour les erreurs ETL</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> ETLError</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">SourceNotFound</span><span class="op">(</span>path<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">InvalidSchema</span><span class="op">(</span>message<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">TransformError</span><span class="op">(</span>message<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">WriteError</span><span class="op">(</span>message<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> ETLError</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong><code>src/main/scala/com/example/jobs/SalesETL.scala</code></strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> com<span class="op">.</span>example<span class="op">.</span>jobs</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> com<span class="op">.</span>example<span class="op">.</span>models<span class="op">.</span>_</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> com<span class="op">.</span>example<span class="op">.</span>utils<span class="op">.</span>SparkSessionWrapper</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.{</span>DataFrame<span class="op">,</span> Dataset<span class="op">}</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.</span>functions<span class="op">.</span>_</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> SalesETL <span class="kw">extends</span> SparkSessionWrapper <span class="op">{</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">import</span> spark<span class="op">.</span>implicits<span class="op">.</span>_</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// EXTRACT</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">extract</span><span class="op">(</span>inputPath<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> Dataset<span class="op">[</span>Sale<span class="op">]]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> df <span class="op">=</span> spark<span class="op">.</span>read</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"header"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"inferSchema"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">csv</span><span class="op">(</span>inputPath<span class="op">)</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Renommer les colonnes pour matcher la case class</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> cleaned <span class="op">=</span> df</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withColumnRenamed</span><span class="op">(</span><span class="st">"transaction_id"</span><span class="op">,</span> <span class="st">"transactionId"</span><span class="op">)</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withColumnRenamed</span><span class="op">(</span><span class="st">"product_category"</span><span class="op">,</span> <span class="st">"productCategory"</span><span class="op">)</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withColumnRenamed</span><span class="op">(</span><span class="st">"customer_id"</span><span class="op">,</span> <span class="st">"customerId"</span><span class="op">)</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Right</span><span class="op">(</span>cleaned<span class="op">.</span>as<span class="op">[</span>Sale<span class="op">])</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> e<span class="op">:</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.</span>AnalysisException <span class="op">=&gt;</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Left</span><span class="op">(</span><span class="fu">SourceNotFound</span><span class="op">(</span>inputPath<span class="op">))</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> e<span class="op">:</span> <span class="ex">Exception</span> <span class="op">=&gt;</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Left</span><span class="op">(</span><span class="fu">InvalidSchema</span><span class="op">(</span>e<span class="op">.</span>getMessage<span class="op">))</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// TRANSFORM</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">transform</span><span class="op">(</span>sales<span class="op">:</span> Dataset<span class="op">[</span>Sale<span class="op">]):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> Dataset<span class="op">[</span>SalesSummary<span class="op">]]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> summary <span class="op">=</span> sales</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>_<span class="op">.</span>amount <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">groupByKey</span><span class="op">(</span>_<span class="op">.</span>productCategory<span class="op">)</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">agg</span><span class="op">(</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span><span class="op">(</span>$<span class="st">"amount"</span><span class="op">).</span>as<span class="op">[</span><span class="ex">Double</span><span class="op">],</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span><span class="op">(</span>$<span class="st">"quantity"</span><span class="op">).</span>as<span class="op">[</span><span class="ex">Long</span><span class="op">],</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>          <span class="fu">avg</span><span class="op">(</span>$<span class="st">"amount"</span><span class="op">).</span>as<span class="op">[</span><span class="ex">Double</span><span class="op">],</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>          <span class="fu">count</span><span class="op">(</span><span class="st">"*"</span><span class="op">).</span>as<span class="op">[</span><span class="ex">Long</span><span class="op">]</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map <span class="op">{</span> <span class="cf">case</span> <span class="op">(</span>category<span class="op">,</span> total<span class="op">,</span> qty<span class="op">,</span> avgSale<span class="op">,</span> count<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>          <span class="fu">SalesSummary</span><span class="op">(</span>category<span class="op">,</span> total<span class="op">,</span> qty<span class="op">,</span> avgSale<span class="op">,</span> count<span class="op">)</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Right</span><span class="op">(</span>summary<span class="op">)</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> e<span class="op">:</span> <span class="ex">Exception</span> <span class="op">=&gt;</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Left</span><span class="op">(</span><span class="fu">TransformError</span><span class="op">(</span>e<span class="op">.</span>getMessage<span class="op">))</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="co">// LOAD</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">load</span><span class="op">(</span>data<span class="op">:</span> Dataset<span class="op">[</span>SalesSummary<span class="op">],</span> outputPath<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> <span class="ex">Long</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>      data<span class="op">.</span>write</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"delta"</span><span class="op">)</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">mode</span><span class="op">(</span><span class="st">"overwrite"</span><span class="op">)</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">save</span><span class="op">(</span>outputPath<span class="op">)</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Right</span><span class="op">(</span>data<span class="op">.</span><span class="fu">count</span><span class="op">())</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> e<span class="op">:</span> <span class="ex">Exception</span> <span class="op">=&gt;</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Left</span><span class="op">(</span><span class="fu">WriteError</span><span class="op">(</span>e<span class="op">.</span>getMessage<span class="op">))</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">// RUN (orchestration avec for-comprehension)</span></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">run</span><span class="op">(</span>inputPath<span class="op">:</span> <span class="ex">String</span><span class="op">,</span> outputPath<span class="op">:</span> <span class="ex">String</span><span class="op">):</span> Either<span class="op">[</span>ETLError<span class="op">,</span> JobSuccess<span class="op">]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> startTime <span class="op">=</span> <span class="ex">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>      sales   <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>inputPath<span class="op">)</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>      _       <span class="op">=</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">ğŸ“¥ Extracted </span><span class="ss">${</span>sales<span class="op">.</span><span class="fu">count</span><span class="op">()</span><span class="ss">}</span><span class="st"> records</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>      summary <span class="op">&lt;-</span> <span class="fu">transform</span><span class="op">(</span>sales<span class="op">)</span></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>      _       <span class="op">=</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">ğŸ”„ Transformed to </span><span class="ss">${</span>summary<span class="op">.</span><span class="fu">count</span><span class="op">()</span><span class="ss">}</span><span class="st"> categories</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>      count   <span class="op">&lt;-</span> <span class="fu">load</span><span class="op">(</span>summary<span class="op">,</span> outputPath<span class="op">)</span></span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>      _       <span class="op">=</span> <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">ğŸ“¤ Loaded </span><span class="ss">$count</span><span class="st"> records to </span><span class="ss">$outputPath"</span><span class="op">)</span></span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">yield</span> <span class="fu">JobSuccess</span><span class="op">(</span></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>      recordsRead <span class="op">=</span> sales<span class="op">.</span><span class="fu">count</span><span class="op">(),</span></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>      recordsWritten <span class="op">=</span> count<span class="op">,</span></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>      durationMs <span class="op">=</span> <span class="ex">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span> <span class="op">-</span> startTime</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong><code>src/main/scala/com/example/Main.scala</code></strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> com<span class="op">.</span>example</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> com<span class="op">.</span>example<span class="op">.</span>jobs<span class="op">.</span>SalesETL</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> com<span class="op">.</span>example<span class="op">.</span>models<span class="op">.</span>_</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> Main <span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">main</span><span class="op">(</span>args<span class="op">:</span> <span class="ex">Array</span><span class="op">[</span><span class="ex">String</span><span class="op">]):</span> <span class="bu">Unit</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> inputPath <span class="op">=</span> args<span class="op">.</span><span class="fu">lift</span><span class="op">(</span><span class="dv">0</span><span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="st">"data/input/sales.csv"</span><span class="op">)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> outputPath <span class="op">=</span> args<span class="op">.</span><span class="fu">lift</span><span class="op">(</span><span class="dv">1</span><span class="op">).</span><span class="fu">getOrElse</span><span class="op">(</span><span class="st">"output/sales_summary"</span><span class="op">)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">ğŸš€ Starting ETL Job</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">   Input:  </span><span class="ss">$inputPath"</span><span class="op">)</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">   Output: </span><span class="ss">$outputPath"</span><span class="op">)</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span><span class="op">()</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    SalesETL<span class="op">.</span><span class="fu">run</span><span class="op">(</span>inputPath<span class="op">,</span> outputPath<span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Right</span><span class="op">(</span><span class="fu">JobSuccess</span><span class="op">(</span>read<span class="op">,</span> written<span class="op">,</span> duration<span class="op">))</span> <span class="op">=&gt;</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span><span class="op">()</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âœ… Job completed successfully!</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">   Records read:    </span><span class="ss">$read"</span><span class="op">)</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">   Records written: </span><span class="ss">$written"</span><span class="op">)</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">   Duration:        </span><span class="ss">${</span>duration<span class="ss">}</span><span class="st">ms</span><span class="ss">"</span><span class="op">)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">SourceNotFound</span><span class="op">(</span>path<span class="op">))</span> <span class="op">=&gt;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span>err<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Source not found: </span><span class="ss">$path"</span><span class="op">)</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span><span class="fu">exit</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">InvalidSchema</span><span class="op">(</span>msg<span class="op">))</span> <span class="op">=&gt;</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span>err<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Invalid schema: </span><span class="ss">$msg"</span><span class="op">)</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span><span class="fu">exit</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">TransformError</span><span class="op">(</span>msg<span class="op">))</span> <span class="op">=&gt;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span>err<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Transform error: </span><span class="ss">$msg"</span><span class="op">)</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span><span class="fu">exit</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="fu">Left</span><span class="op">(</span><span class="fu">WriteError</span><span class="op">(</span>msg<span class="op">))</span> <span class="op">=&gt;</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span>err<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">âŒ Write error: </span><span class="ss">$msg"</span><span class="op">)</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        <span class="ex">System</span><span class="op">.</span><span class="fu">exit</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ArrÃªter Spark proprement</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    SalesETL<span class="op">.</span>spark<span class="op">.</span><span class="fu">stop</span><span class="op">()</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="donnÃ©es-de-test" class="level3">
<h3 class="anchored" data-anchor-id="donnÃ©es-de-test">3.5 DonnÃ©es de test</h3>
<p><strong><code>data/input/sales.csv</code></strong> :</p>
<pre class="csv"><code>transaction_id,product_category,amount,quantity,date,customer_id
TXN001,Electronics,1299.99,1,2024-01-15,CUST001
TXN002,Clothing,89.99,3,2024-01-15,CUST002
TXN003,Electronics,599.99,1,2024-01-16,CUST001
TXN004,Food,45.50,10,2024-01-16,CUST003
TXN005,Clothing,129.99,2,2024-01-17,CUST002
TXN006,Electronics,199.99,2,2024-01-17,CUST004
TXN007,Food,78.25,5,2024-01-18,CUST001
TXN008,Clothing,299.99,1,2024-01-18,CUST005
TXN009,Electronics,899.99,1,2024-01-19,CUST003
TXN010,Food,156.00,8,2024-01-19,CUST002</code></pre>
</section>
<section id="exÃ©cuter-dans-intellij" class="level3">
<h3 class="anchored" data-anchor-id="exÃ©cuter-dans-intellij">3.6 ExÃ©cuter dans IntelliJ</h3>
<ol type="1">
<li><strong>Clic droit sur <code>Main.scala</code></strong> â†’ <strong>Run â€˜Mainâ€™</strong></li>
<li>Ou crÃ©er une <strong>Run Configuration</strong> :
<ul>
<li>Run â†’ Edit Configurations â†’ + â†’ Application</li>
<li>Main class : <code>com.example.Main</code></li>
<li>Program arguments : <code>data/input/sales.csv output/sales_summary</code></li>
<li>VM options : <code>--add-opens java.base/sun.nio.ch=ALL-UNNAMED</code> (Java 17)</li>
</ul></li>
</ol>
</section>
<section id="builder-le-jar" class="level3">
<h3 class="anchored" data-anchor-id="builder-le-jar">3.7 Builder le JAR</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dans le terminal IntelliJ (View â†’ Tool Windows â†’ Terminal)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compiler</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sbt</span> compile</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># CrÃ©er le fat JAR (inclut toutes les dÃ©pendances sauf Spark)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">sbt</span> assembly</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Le JAR est crÃ©Ã© dans :</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># target/scala-2.12/spark-etl-project-1.0.0.jar</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exÃ©cuter-avec-spark-submit-local" class="level3">
<h3 class="anchored" data-anchor-id="exÃ©cuter-avec-spark-submit-local">3.8 ExÃ©cuter avec spark-submit (local)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">spark-submit</span> <span class="dt">\</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--master</span> local<span class="pp">[</span><span class="ss">*</span><span class="pp">]</span> <span class="dt">\</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--driver-memory</span> 2g <span class="dt">\</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--class</span> com.example.Main <span class="dt">\</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--packages</span> io.delta:delta-spark_2.12:3.1.0 <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  target/scala-2.12/spark-etl-project-1.0.0.jar <span class="dt">\</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  data/input/sales.csv <span class="dt">\</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  output/sales_summary</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exÃ©cuter-sur-cluster-yarnk8s" class="level3">
<h3 class="anchored" data-anchor-id="exÃ©cuter-sur-cluster-yarnk8s">3.9 ExÃ©cuter sur cluster (YARN/K8s)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># YARN</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">spark-submit</span> <span class="dt">\</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--master</span> yarn <span class="dt">\</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--deploy-mode</span> cluster <span class="dt">\</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--driver-memory</span> 4g <span class="dt">\</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--executor-memory</span> 8g <span class="dt">\</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--executor-cores</span> 4 <span class="dt">\</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--num-executors</span> 10 <span class="dt">\</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--class</span> com.example.Main <span class="dt">\</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--packages</span> io.delta:delta-spark_2.12:3.1.0 <span class="dt">\</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  spark-etl-project-1.0.0.jar <span class="dt">\</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  hdfs:///data/input/sales.csv <span class="dt">\</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  hdfs:///data/output/sales_summary</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Kubernetes (voir M27)</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="ex">spark-submit</span> <span class="dt">\</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">--master</span> k8s://https://k8s-api:6443 <span class="dt">\</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">--deploy-mode</span> cluster <span class="dt">\</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">--conf</span> spark.kubernetes.container.image=my-spark:3.5.0 <span class="dt">\</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">--class</span> com.example.Main <span class="dt">\</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  local:///opt/spark/jars/spark-etl-project-1.0.0.jar</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="connecteurs-jars-et-configuration" class="level2">
<h2 class="anchored" data-anchor-id="connecteurs-jars-et-configuration">4. Connecteurs : JARs et Configuration</h2>
<section id="jars-requis-par-source-de-donnÃ©es" class="level3">
<h3 class="anchored" data-anchor-id="jars-requis-par-source-de-donnÃ©es">4.1 JARs requis par source de donnÃ©es</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 15%">
<col style="width: 59%">
</colgroup>
<thead>
<tr class="header">
<th>Source</th>
<th>JAR</th>
<th>Maven coordinates</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>PostgreSQL</strong></td>
<td>postgresql-42.7.0.jar</td>
<td><code>org.postgresql:postgresql:42.7.0</code></td>
</tr>
<tr class="even">
<td><strong>MySQL</strong></td>
<td>mysql-connector-j-8.0.33.jar</td>
<td><code>com.mysql:mysql-connector-j:8.0.33</code></td>
</tr>
<tr class="odd">
<td><strong>SQL Server</strong></td>
<td>mssql-jdbc-12.4.0.jar</td>
<td><code>com.microsoft.sqlserver:mssql-jdbc:12.4.0</code></td>
</tr>
<tr class="even">
<td><strong>Oracle</strong></td>
<td>ojdbc11-23.3.0.0.jar</td>
<td><code>com.oracle.database.jdbc:ojdbc11:23.3.0.0</code></td>
</tr>
<tr class="odd">
<td><strong>Kafka</strong></td>
<td>spark-sql-kafka-0-10_2.12-3.5.0.jar</td>
<td><code>org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.0</code></td>
</tr>
<tr class="even">
<td><strong>Delta Lake</strong></td>
<td>delta-spark_2.12-3.1.0.jar</td>
<td><code>io.delta:delta-spark_2.12:3.1.0</code></td>
</tr>
<tr class="odd">
<td><strong>Iceberg</strong></td>
<td>iceberg-spark-runtime-3.5_2.12-1.4.0.jar</td>
<td><code>org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.4.0</code></td>
</tr>
<tr class="even">
<td><strong>AWS S3</strong></td>
<td>hadoop-aws-3.3.4.jar + aws-java-sdk-bundle</td>
<td><code>org.apache.hadoop:hadoop-aws:3.3.4</code></td>
</tr>
<tr class="odd">
<td><strong>GCS</strong></td>
<td>gcs-connector-hadoop3-2.2.17.jar</td>
<td>â€” (tÃ©lÃ©chargement manuel)</td>
</tr>
</tbody>
</table>
</section>
<section id="ajouter-dans-build.sbt" class="level3">
<h3 class="anchored" data-anchor-id="ajouter-dans-build.sbt">4.2 Ajouter dans build.sbt</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>libraryDependencies <span class="op">++=</span> <span class="bu">Seq</span><span class="op">(</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Spark (provided = dÃ©jÃ  sur le cluster)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"org.apache.spark"</span> <span class="op">%%</span> <span class="st">"spark-sql"</span> <span class="op">%</span> <span class="st">"3.5.0"</span> <span class="op">%</span> <span class="st">"provided"</span><span class="op">,</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Connecteurs (compile = inclus dans le JAR)</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"org.postgresql"</span> <span class="op">%</span> <span class="st">"postgresql"</span> <span class="op">%</span> <span class="st">"42.7.0"</span><span class="op">,</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"org.apache.spark"</span> <span class="op">%%</span> <span class="st">"spark-sql-kafka-0-10"</span> <span class="op">%</span> <span class="st">"3.5.0"</span><span class="op">,</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"io.delta"</span> <span class="op">%%</span> <span class="st">"delta-spark"</span> <span class="op">%</span> <span class="st">"3.1.0"</span><span class="op">,</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="spark-submit-jars-vs-packages" class="level3">
<h3 class="anchored" data-anchor-id="spark-submit-jars-vs-packages">4.3 spark-submit : â€“jars vs â€“packages</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Option</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>--jars</code></td>
<td>Chemins locaux ou HDFS vers des JARs</td>
</tr>
<tr class="even">
<td><code>--packages</code></td>
<td>CoordonnÃ©es Maven (tÃ©lÃ©chargement automatique)</td>
</tr>
<tr class="odd">
<td><code>--repositories</code></td>
<td>Repos Maven custom</td>
</tr>
<tr class="even">
<td><code>--driver-class-path</code></td>
<td>JARs pour le driver uniquement</td>
</tr>
</tbody>
</table>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Avec JARs locaux</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">spark-submit</span> <span class="dt">\</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--jars</span> /path/to/postgresql-42.7.0.jar,/path/to/delta-spark_2.12-3.1.0.jar <span class="dt">\</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  my-app.jar</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Avec tÃ©lÃ©chargement Maven</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ex">spark-submit</span> <span class="dt">\</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--packages</span> org.postgresql:postgresql:42.7.0,io.delta:delta-spark_2.12:3.1.0 <span class="dt">\</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  my-app.jar</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Repo custom</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="ex">spark-submit</span> <span class="dt">\</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">--repositories</span> https://my-company.jfrog.io/artifactory/libs-release <span class="dt">\</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">--packages</span> com.mycompany:my-lib:1.0.0 <span class="dt">\</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  my-app.jar</span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exemples-de-connexion" class="level3">
<h3 class="anchored" data-anchor-id="exemples-de-connexion">4.4 Exemples de connexion</h3>
<blockquote class="blockquote">
<p>â„¹ï¸ <strong>Note</strong> : Ces exemples supposent que vous avez accÃ¨s aux services correspondants.</p>
</blockquote>
<p><strong>PostgreSQL</strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df <span class="op">=</span> spark<span class="op">.</span>read</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"jdbc"</span><span class="op">)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"url"</span><span class="op">,</span> <span class="st">"jdbc:postgresql://localhost:5432/mydb"</span><span class="op">)</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"dbtable"</span><span class="op">,</span> <span class="st">"customers"</span><span class="op">)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"user"</span><span class="op">,</span> <span class="st">"postgres"</span><span class="op">)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"password"</span><span class="op">,</span> <span class="st">"secret"</span><span class="op">)</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"driver"</span><span class="op">,</span> <span class="st">"org.postgresql.Driver"</span><span class="op">)</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">load</span><span class="op">()</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Kafka</strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df <span class="op">=</span> spark<span class="op">.</span>readStream</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"kafka"</span><span class="op">)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"kafka.bootstrap.servers"</span><span class="op">,</span> <span class="st">"localhost:9092"</span><span class="op">)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"subscribe"</span><span class="op">,</span> <span class="st">"events"</span><span class="op">)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">option</span><span class="op">(</span><span class="st">"startingOffsets"</span><span class="op">,</span> <span class="st">"earliest"</span><span class="op">)</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">load</span><span class="op">()</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Delta Lake</strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Lecture</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df <span class="op">=</span> spark<span class="op">.</span>read<span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"delta"</span><span class="op">).</span><span class="fu">load</span><span class="op">(</span><span class="st">"/path/to/delta"</span><span class="op">)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã‰criture</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span>write<span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"delta"</span><span class="op">).</span><span class="fu">mode</span><span class="op">(</span><span class="st">"overwrite"</span><span class="op">).</span><span class="fu">save</span><span class="op">(</span><span class="st">"/path/to/delta"</span><span class="op">)</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Time travel</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> dfV2 <span class="op">=</span> spark<span class="op">.</span>read<span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="st">"delta"</span><span class="op">).</span><span class="fu">option</span><span class="op">(</span><span class="st">"versionAsOf"</span><span class="op">,</span> <span class="dv">2</span><span class="op">).</span><span class="fu">load</span><span class="op">(</span><span class="st">"/path/to/delta"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="catalyst-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="catalyst-optimizer">5. Catalyst Optimizer</h2>
<p><strong>Catalyst</strong> est le moteur dâ€™optimisation de Spark SQL. Il transforme ton code en un plan dâ€™exÃ©cution optimal.</p>
<section id="phases-doptimisation" class="level3">
<h3 class="anchored" data-anchor-id="phases-doptimisation">5.1 Phases dâ€™optimisation</h3>
<pre class="text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CATALYST OPTIMIZER                                  â”‚
â”‚                                                                             â”‚
â”‚   Code SQL/DataFrame                                                        â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚    ANALYSIS     â”‚  RÃ©soudre les noms de colonnes, tables               â”‚
â”‚   â”‚                 â”‚  VÃ©rifier les types                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â–¼                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚ LOGICAL OPTIM   â”‚  Predicate pushdown, Column pruning                  â”‚
â”‚   â”‚                 â”‚  Constant folding, Filter reordering                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â–¼                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚ PHYSICAL PLAN   â”‚  Choisir les algorithmes (Sort-Merge vs Broadcast)   â”‚
â”‚   â”‚                 â”‚  Cost-Based Optimization                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â–¼                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚   â”‚ CODE GENERATION â”‚  GÃ©nÃ©rer du bytecode Java optimisÃ©                   â”‚
â”‚   â”‚   (Tungsten)    â”‚  Whole-Stage Code Generation                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚            â–¼                                                                â”‚
â”‚        EXECUTION                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</section>
<section id="lire-un-plan-dexÃ©cution" class="level3">
<h3 class="anchored" data-anchor-id="lire-un-plan-dexÃ©cution">5.2 Lire un plan dâ€™exÃ©cution</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df <span class="op">=</span> spark<span class="op">.</span>read<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span><span class="st">"data/sales"</span><span class="op">)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>$<span class="st">"amount"</span> <span class="op">&gt;</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">groupBy</span><span class="op">(</span><span class="st">"category"</span><span class="op">)</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">agg</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="st">"amount"</span><span class="op">))</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Plan simple</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">()</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Plan dÃ©taillÃ© (Parsed â†’ Analyzed â†’ Optimized â†’ Physical)</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Plan formatÃ© (Spark 3.0+)</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">(</span><span class="st">"formatted"</span><span class="op">)</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Plan avec coÃ»ts (si CBO activÃ©)</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="exemple-de-plan" class="level3">
<h3 class="anchored" data-anchor-id="exemple-de-plan">5.3 Exemple de plan</h3>
<pre class="text"><code>== Physical Plan ==
AdaptiveSparkPlan isFinalPlan=false
+- HashAggregate(keys=[category#12], functions=[sum(amount#14)])
   +- Exchange hashpartitioning(category#12, 200)        â† SHUFFLE
      +- HashAggregate(keys=[category#12], functions=[partial_sum(amount#14)])
         +- Project [category#12, amount#14]             â† Colonnes sÃ©lectionnÃ©es
            +- Filter (amount#14 &gt; 100)                  â† Filtre pushdown
               +- FileScan parquet [category#12,amount#14]  â† Lecture</code></pre>
<p><strong>Ce quâ€™il faut regarder</strong> : - <strong>Exchange</strong> = Shuffle (coÃ»teux !) - <strong>BroadcastHashJoin</strong> vs <strong>SortMergeJoin</strong> (broadcast = plus rapide si petite table) - <strong>FileScan</strong> : colonnes pruned, partitions pruned - <strong>Filter</strong> : poussÃ© au plus prÃ¨s de la source</p>
</section>
<section id="cost-based-optimization-cbo" class="level3">
<h3 class="anchored" data-anchor-id="cost-based-optimization-cbo">5.4 Cost-Based Optimization (CBO)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Activer CBO</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.cbo.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.cbo.joinReorder.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Collecter les statistiques (important !)</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span><span class="fu">sql</span><span class="op">(</span><span class="st">"ANALYZE TABLE sales COMPUTE STATISTICS"</span><span class="op">)</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span><span class="fu">sql</span><span class="op">(</span><span class="st">"ANALYZE TABLE sales COMPUTE STATISTICS FOR COLUMNS amount, category"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="adaptive-query-execution-aqe" class="level2">
<h2 class="anchored" data-anchor-id="adaptive-query-execution-aqe">6. Adaptive Query Execution (AQE)</h2>
<p><strong>AQE</strong> (Spark 3.0+) optimise le plan dâ€™exÃ©cution <strong>pendant</strong> lâ€™exÃ©cution, en se basant sur les statistiques rÃ©elles.</p>
<section id="fonctionnalitÃ©s" class="level3">
<h3 class="anchored" data-anchor-id="fonctionnalitÃ©s">6.1 FonctionnalitÃ©s</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 59%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Coalesce Partitions</strong></td>
<td>Fusionner les petites partitions aprÃ¨s shuffle</td>
</tr>
<tr class="even">
<td><strong>Broadcast Join Conversion</strong></td>
<td>Convertir Sort-Merge â†’ Broadcast si table petite</td>
</tr>
<tr class="odd">
<td><strong>Skew Join Optimization</strong></td>
<td>Splitter les partitions dÃ©sÃ©quilibrÃ©es</td>
</tr>
</tbody>
</table>
</section>
<section id="configuration" class="level3">
<h3 class="anchored" data-anchor-id="configuration">6.2 Configuration</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Activer AQE (activÃ© par dÃ©faut depuis Spark 3.2)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Coalesce automatique</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.coalescePartitions.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.coalescePartitions.minPartitionSize"</span><span class="op">,</span> <span class="st">"64MB"</span><span class="op">)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Broadcast dynamique</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.autoBroadcastJoinThreshold"</span><span class="op">,</span> <span class="st">"10MB"</span><span class="op">)</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Skew join</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.skewJoin.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.skewJoin.skewedPartitionFactor"</span><span class="op">,</span> <span class="st">"5"</span><span class="op">)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes"</span><span class="op">,</span> <span class="st">"256MB"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="voir-aqe-en-action" class="level3">
<h3 class="anchored" data-anchor-id="voir-aqe-en-action">6.3 Voir AQE en action</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Le plan montre "AdaptiveSparkPlan"</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">()</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">// == Physical Plan ==</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">// AdaptiveSparkPlan isFinalPlan=true    â† AQE activÃ© !</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">// +- ...</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">// AprÃ¨s exÃ©cution, voir le plan final</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">collect</span><span class="op">()</span>  <span class="co">// ExÃ©cuter d'abord</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">()</span>  <span class="co">// Maintenant isFinalPlan=true</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="tungsten-engine" class="level2">
<h2 class="anchored" data-anchor-id="tungsten-engine">7. Tungsten Engine</h2>
<p><strong>Tungsten</strong> est le moteur dâ€™exÃ©cution bas-niveau de Spark, optimisÃ© pour le CPU et la mÃ©moire.</p>
<section id="optimisations-tungsten" class="level3">
<h3 class="anchored" data-anchor-id="optimisations-tungsten">7.1 Optimisations Tungsten</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Optimisation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Off-heap Memory</strong></td>
<td>Stockage hors JVM heap (Ã©vite GC)</td>
</tr>
<tr class="even">
<td><strong>Binary Format</strong></td>
<td>DonnÃ©es en format binaire compact</td>
</tr>
<tr class="odd">
<td><strong>Cache-aware</strong></td>
<td>Algorithmes optimisÃ©s pour le cache CPU</td>
</tr>
<tr class="even">
<td><strong>Whole-Stage CodeGen</strong></td>
<td>Compile le plan en bytecode Java</td>
</tr>
</tbody>
</table>
</section>
<section id="whole-stage-code-generation" class="level3">
<h3 class="anchored" data-anchor-id="whole-stage-code-generation">7.2 Whole-Stage Code Generation</h3>
<p>Au lieu dâ€™appeler des fonctions virtuelles pour chaque row, Tungsten gÃ©nÃ¨re du code spÃ©cialisÃ©.</p>
<pre class="text"><code>SANS CODEGEN                          AVEC CODEGEN
                                      
for (row in data) {                   // Code gÃ©nÃ©rÃ© automatiquement
  filter.eval(row)   â† virtual call   for (row in data) {
  project.eval(row)  â† virtual call     if (row.amount &gt; 100) {
  agg.update(row)    â† virtual call       sum += row.amount
}                                       }
                                      }</code></pre>
</section>
<section id="voir-le-code-gÃ©nÃ©rÃ©" class="level3">
<h3 class="anchored" data-anchor-id="voir-le-code-gÃ©nÃ©rÃ©">7.3 Voir le code gÃ©nÃ©rÃ©</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Activer le debug</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.codegen.wholeStage"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Voir le code gÃ©nÃ©rÃ©</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span>queryExecution<span class="op">.</span>debug<span class="op">.</span><span class="fu">codegen</span><span class="op">()</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
</section>
<section id="memory-management-tuning" class="level2">
<h2 class="anchored" data-anchor-id="memory-management-tuning">8. Memory Management &amp; Tuning</h2>
<section id="architecture-mÃ©moire-spark" class="level3">
<h3 class="anchored" data-anchor-id="architecture-mÃ©moire-spark">8.1 Architecture MÃ©moire Spark</h3>
<pre class="text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EXECUTOR MEMORY (spark.executor.memory)                 â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                SPARK MEMORY (spark.memory.fraction = 0.6)           â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚   â”‚   â”‚   STORAGE MEMORY    â”‚   â”‚      EXECUTION MEMORY           â”‚    â”‚  â”‚
â”‚   â”‚   â”‚                     â”‚   â”‚                                 â”‚    â”‚  â”‚
â”‚   â”‚   â”‚   Cache, Broadcast  â”‚ âŸ· â”‚   Shuffle, Join, Sort, Agg     â”‚    â”‚  â”‚
â”‚   â”‚   â”‚                     â”‚   â”‚                                 â”‚    â”‚  â”‚
â”‚   â”‚   â”‚   (storageFraction  â”‚   â”‚   (1 - storageFraction          â”‚    â”‚  â”‚
â”‚   â”‚   â”‚    = 0.5)           â”‚   â”‚    = 0.5)                       â”‚    â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   â† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unified Memory (frontiÃ¨re flexible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†’ â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    USER MEMORY (0.4)                                â”‚  â”‚
â”‚   â”‚   Structures internes, UDFs, mÃ©tadonnÃ©es                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    RESERVED MEMORY (300MB fixe)                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</section>
<section id="configurations-mÃ©moire" class="level3">
<h3 class="anchored" data-anchor-id="configurations-mÃ©moire">8.2 Configurations MÃ©moire</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// MÃ©moire totale executor</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.executor.memory"</span><span class="op">,</span> <span class="st">"8g"</span><span class="op">)</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Fraction pour Spark (vs User)</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.memory.fraction"</span><span class="op">,</span> <span class="st">"0.6"</span><span class="op">)</span>  <span class="co">// 60% pour Spark</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Fraction Storage dans Spark Memory</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.memory.storageFraction"</span><span class="op">,</span> <span class="st">"0.5"</span><span class="op">)</span>  <span class="co">// 50% Storage, 50% Execution</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Off-heap (Tungsten)</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.memory.offHeap.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.memory.offHeap.size"</span><span class="op">,</span> <span class="st">"4g"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="pourquoi-80-des-jobs-spark-sont-lents" class="level3">
<h3 class="anchored" data-anchor-id="pourquoi-80-des-jobs-spark-sont-lents">8.3 Pourquoi 80% des Jobs Spark sont Lents ğŸ”¥</h3>
<pre class="text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            LES 5 CAUSES DE 80% DES JOBS SPARK LENTS                         â”‚
â”‚                                                                             â”‚
â”‚   1ï¸âƒ£ DATA SKEW (40%)                                                        â”‚
â”‚      â””â”€ 1 partition avec 10M rows, les autres avec 1K                       â”‚
â”‚      â””â”€ SymptÃ´me : 199 tasks Ã  2s, 1 task Ã  45min                          â”‚
â”‚      â””â”€ Fix : salting, repartition par clÃ©, AQE skew join                  â”‚
â”‚                                                                             â”‚
â”‚   2ï¸âƒ£ SHUFFLE EXCESSIF (25%)                                                 â”‚
â”‚      â””â”€ Trop de groupBy/join, pas de broadcast                              â”‚
â”‚      â””â”€ SymptÃ´me : "Shuffle Write" Ã©norme dans Spark UI                    â”‚
â”‚      â””â”€ Fix : broadcast join, rÃ©duire colonnes avant shuffle               â”‚
â”‚                                                                             â”‚
â”‚   3ï¸âƒ£ MAUVAIS PARTITIONING (15%)                                             â”‚
â”‚      â””â”€ 200 partitions par dÃ©faut, fichiers trop petits/gros                â”‚
â”‚      â””â”€ SymptÃ´me : 10000 tasks de 100KB ou 2 tasks de 50GB                 â”‚
â”‚      â””â”€ Fix : repartition/coalesce, AQE coalesce, tuning shuffle.partitionsâ”‚
â”‚                                                                             â”‚
â”‚   4ï¸âƒ£ SPILL TO DISK (10%)                                                    â”‚
â”‚      â””â”€ MÃ©moire insuffisante, donnÃ©es Ã©crites sur disque                    â”‚
â”‚      â””â”€ SymptÃ´me : "Spill (Memory)" dans Stage details                     â”‚
â”‚      â””â”€ Fix : augmenter executor memory, rÃ©duire taille partitions         â”‚
â”‚                                                                             â”‚
â”‚   5ï¸âƒ£ SMALL FILES PROBLEM (10%)                                              â”‚
â”‚      â””â”€ Lire 10000 fichiers de 1MB au lieu de 100 de 100MB                  â”‚
â”‚      â””â”€ SymptÃ´me : temps de listing S3 trÃ¨s long, driver OOM               â”‚
â”‚      â””â”€ Fix : compaction Delta, maxPartitionBytes, bin-packing             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</section>
<section id="diagnostic-toolkit" class="level3">
<h3 class="anchored" data-anchor-id="diagnostic-toolkit">8.4 Diagnostic Toolkit</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. VÃ©rifier le plan d'exÃ©cution</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span>          <span class="co">// Plan complet</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">explain</span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span>        <span class="co">// Avec coÃ»ts estimÃ©s</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Voir le nombre de partitions</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span><span class="op">(</span><span class="ss">s"</span><span class="st">Partitions: </span><span class="ss">${</span>df<span class="op">.</span>rdd<span class="op">.</span>getNumPartitions<span class="ss">}"</span><span class="op">)</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. DÃ©tecter le skew (distribution par partition)</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.</span>functions<span class="op">.</span>_</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span><span class="fu">withColumn</span><span class="op">(</span><span class="st">"partition_id"</span><span class="op">,</span> <span class="fu">spark_partition_id</span><span class="op">())</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">groupBy</span><span class="op">(</span><span class="st">"partition_id"</span><span class="op">)</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">count</span><span class="op">()</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">orderBy</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="st">"count"</span><span class="op">))</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">show</span><span class="op">()</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co">// 4. Voir la taille des partitions</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>df<span class="op">.</span>rdd<span class="op">.</span>mapPartitionsWithIndex <span class="op">{</span> <span class="cf">case</span> <span class="op">(</span>idx<span class="op">,</span> iter<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Iterator</span><span class="op">((</span>idx<span class="op">,</span> iter<span class="op">.</span>size<span class="op">))</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="op">}.</span><span class="fu">toDF</span><span class="op">(</span><span class="st">"partition"</span><span class="op">,</span> <span class="st">"rows"</span><span class="op">).</span><span class="fu">show</span><span class="op">()</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co">// 5. MÃ©triques pendant l'exÃ©cution</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>spark<span class="op">.</span>conf<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">"spark.sql.adaptive.skewJoin.enabled"</span><span class="op">,</span> <span class="st">"true"</span><span class="op">)</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="spark-ui-ce-quil-faut-regarder" class="level3">
<h3 class="anchored" data-anchor-id="spark-ui-ce-quil-faut-regarder">8.5 Spark UI : Ce quâ€™il faut regarder</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Onglet</th>
<th>Ce quâ€™on cherche</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Jobs</strong></td>
<td>DurÃ©e totale, jobs qui traÃ®nent</td>
</tr>
<tr class="even">
<td><strong>Stages</strong></td>
<td>Shuffle Read/Write, Spill, tÃ¢ches en retard</td>
</tr>
<tr class="odd">
<td><strong>Tasks</strong></td>
<td>Distribution (min/median/max), stragglers</td>
</tr>
<tr class="even">
<td><strong>Storage</strong></td>
<td>Cache utilisÃ©, mÃ©moire disponible</td>
</tr>
<tr class="odd">
<td><strong>SQL</strong></td>
<td>Plan physique, mÃ©triques par opÃ©rateur</td>
</tr>
<tr class="even">
<td><strong>Executors</strong></td>
<td>MÃ©moire, GC time, shuffle read/write</td>
</tr>
</tbody>
</table>
</section>
<section id="debugging-oom" class="level3">
<h3 class="anchored" data-anchor-id="debugging-oom">8.6 Debugging OOM</h3>
<pre class="text"><code>java.lang.OutOfMemoryError: Java heap space

CAUSES PROBABLES :
â”œâ”€â”€ collect() sur un gros DataFrame
â”œâ”€â”€ broadcast() d'une table trop grande
â”œâ”€â”€ Trop de partitions small â†’ overhead
â”œâ”€â”€ Skew â†’ 1 executor avec trop de donnÃ©es
â””â”€â”€ Driver OOM â†’ trop de metadata / rÃ©sultats

SOLUTIONS :
â”œâ”€â”€ Augmenter spark.executor.memory
â”œâ”€â”€ Augmenter spark.driver.memory (si driver OOM)
â”œâ”€â”€ Repartitionner les donnÃ©es
â”œâ”€â”€ Ã‰viter collect(), utiliser take() ou write()
â””â”€â”€ RÃ©duire spark.sql.autoBroadcastJoinThreshold</code></pre>
<hr>
</section>
</section>
<section id="exercices-pratiques" class="level2">
<h2 class="anchored" data-anchor-id="exercices-pratiques">9. Exercices Pratiques</h2>
<section id="exercice-1-pratique-scala-adt-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="exercice-1-pratique-scala-adt-pipeline">Exercice 1 : Pratique Scala â€” ADT Pipeline</h3>
<p>ModÃ©liser un pipeline de traitement avec des ADT.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: CrÃ©er un sealed trait pour les Ã©tapes du pipeline</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Ã‰tapes : Extract, Validate, Transform, Load</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Chaque Ã©tape peut Success ou Fail</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: ImplÃ©menter une fonction qui exÃ©cute le pipeline</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">// et retourne un rapport dÃ©taillÃ© de chaque Ã©tape</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<details>
<summary>
ğŸ’¡ Solution
</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> PipelineStep</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Extract <span class="kw">extends</span> PipelineStep</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Validate <span class="kw">extends</span> PipelineStep</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> <span class="ex">Transform</span> <span class="kw">extends</span> PipelineStep</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">object</span> Load <span class="kw">extends</span> PipelineStep</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">trait</span> StepResult</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">StepSuccess</span><span class="op">(</span>step<span class="op">:</span> PipelineStep<span class="op">,</span> durationMs<span class="op">:</span> <span class="ex">Long</span><span class="op">,</span> records<span class="op">:</span> <span class="ex">Long</span><span class="op">)</span> <span class="kw">extends</span> StepResult</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">StepFailure</span><span class="op">(</span>step<span class="op">:</span> PipelineStep<span class="op">,</span> error<span class="op">:</span> <span class="ex">String</span><span class="op">)</span> <span class="kw">extends</span> StepResult</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">PipelineReport</span><span class="op">(</span>results<span class="op">:</span> <span class="ex">List</span><span class="op">[</span>StepResult<span class="op">])</span> <span class="op">{</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> isSuccess<span class="op">:</span> <span class="ex">Boolean</span> <span class="op">=</span> results<span class="op">.</span><span class="fu">forall</span><span class="op">(</span>_<span class="op">.</span>isInstanceOf<span class="op">[</span>StepSuccess<span class="op">])</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> failedStep<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span>StepFailure<span class="op">]</span> <span class="op">=</span> results<span class="op">.</span>collectFirst <span class="op">{</span> <span class="cf">case</span> f<span class="op">:</span> StepFailure <span class="op">=&gt;</span> f <span class="op">}</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<hr>
</section>
<section id="exercice-2-either-pour-etl" class="level3">
<h3 class="anchored" data-anchor-id="exercice-2-either-pour-etl">Exercice 2 : Either pour ETL</h3>
<p>ImplÃ©menter un mini-ETL avec gestion dâ€™erreurs typÃ©e.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: CrÃ©er une fonction qui :</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Lit un fichier CSV (peut Ã©chouer : FileNotFound)</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Valide que la colonne "amount" existe (peut Ã©chouer : SchemaError)</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. Filtre les montants &gt; 0 (peut Ã©chouer : DataError si 0 records)</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 4. Ã‰crit en Parquet</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Utiliser Either[ETLError, DataFrame] Ã  chaque Ã©tape</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">// ChaÃ®ner avec for-comprehension</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="exercice-3-setup-almond-spark" class="level3">
<h3 class="anchored" data-anchor-id="exercice-3-setup-almond-spark">Exercice 3 : Setup Almond + Spark</h3>
<ol type="1">
<li>Installer Almond (suivre les instructions section 2.1)</li>
<li>CrÃ©er un notebook Scala</li>
<li>Importer Spark et Delta Lake</li>
<li>CrÃ©er un DataFrame, le transformer, lâ€™Ã©crire en Delta</li>
</ol>
<hr>
</section>
<section id="exercice-4-projet-intellij-complet" class="level3">
<h3 class="anchored" data-anchor-id="exercice-4-projet-intellij-complet">Exercice 4 : Projet IntelliJ Complet</h3>
<ol type="1">
<li>CrÃ©er le projet selon la structure section 3</li>
<li>Ajouter les fichiers de config</li>
<li>ImplÃ©menter le code</li>
<li>CrÃ©er le fichier CSV de test</li>
<li>ExÃ©cuter dans IntelliJ</li>
<li>Builder avec <code>sbt assembly</code></li>
<li>Lancer avec <code>spark-submit</code></li>
</ol>
<hr>
</section>
<section id="exercice-5-diagnostiquer-un-job-lent" class="level3">
<h3 class="anchored" data-anchor-id="exercice-5-diagnostiquer-un-job-lent">Exercice 5 : Diagnostiquer un Job Lent</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Ce code est intentionnellement lent. Pourquoi ?</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df1 <span class="op">=</span> spark<span class="op">.</span>read<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span><span class="st">"big_table"</span><span class="op">)</span>  <span class="co">// 100M rows</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> df2 <span class="op">=</span> spark<span class="op">.</span>read<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span><span class="st">"small_table"</span><span class="op">)</span>  <span class="co">// 1000 rows</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result <span class="op">=</span> df1</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">join</span><span class="op">(</span>df2<span class="op">,</span> <span class="st">"key"</span><span class="op">)</span>  <span class="co">// Quel type de join ?</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">groupBy</span><span class="op">(</span><span class="st">"category"</span><span class="op">)</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">agg</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="st">"amount"</span><span class="op">))</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">collect</span><span class="op">()</span>  <span class="co">// ProblÃ¨me ?</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">: </span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Identifier les problÃ¨mes</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Proposer des optimisations</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. RÃ©Ã©crire le code optimisÃ©</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
<details>
<summary>
ğŸ’¡ Solution
</summary>
<p><strong>ProblÃ¨mes</strong> : 1. Join sans broadcast â†’ Sort-Merge Join (shuffle de 100M rows) 2. collect() sur un rÃ©sultat potentiellement gros</p>
<p><strong>Solution</strong> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode scala code-with-copy"><code class="sourceCode scala"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>sql<span class="op">.</span>functions<span class="op">.</span>broadcast</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> result <span class="op">=</span> df1</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">join</span><span class="op">(</span><span class="fu">broadcast</span><span class="op">(</span>df2<span class="op">),</span> <span class="st">"key"</span><span class="op">)</span>  <span class="co">// Broadcast join !</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">groupBy</span><span class="op">(</span><span class="st">"category"</span><span class="op">)</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">agg</span><span class="op">(</span><span class="fu">sum</span><span class="op">(</span><span class="st">"amount"</span><span class="op">))</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span>write<span class="op">.</span><span class="fu">parquet</span><span class="op">(</span><span class="st">"output"</span><span class="op">)</span>  <span class="co">// Ã‰crire au lieu de collect</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<hr>
</section>
</section>
<section id="mini-projet-etl-scala-bronze-silver-gold" class="level2">
<h2 class="anchored" data-anchor-id="mini-projet-etl-scala-bronze-silver-gold">10. Mini-Projet : ETL Scala Bronze â†’ Silver â†’ Gold</h2>
<section id="objectif" class="level3">
<h3 class="anchored" data-anchor-id="objectif">Objectif</h3>
<p>Construire un pipeline ETL complet en Scala avec architecture Medallion.</p>
<pre class="text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MEDALLION ARCHITECTURE                              â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚   BRONZE    â”‚ â”€â”€â”€â–¶ â”‚   SILVER    â”‚ â”€â”€â”€â–¶ â”‚    GOLD     â”‚                â”‚
â”‚   â”‚   (Raw)     â”‚      â”‚  (Cleaned)  â”‚      â”‚ (Aggregated)â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                             â”‚
â”‚   CSV/JSON           Delta Lake           Delta Lake                        â”‚
â”‚   + metadata         + validation         + business KPIs                   â”‚
â”‚   + ingestion_ts     + dedup              + reporting ready                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
</section>
<section id="livrables" class="level3">
<h3 class="anchored" data-anchor-id="livrables">Livrables</h3>
<ol type="1">
<li>Projet IntelliJ complet avec structure</li>
<li>ADT pour les erreurs et rÃ©sultats</li>
<li>3 jobs : BronzeJob, SilverJob, GoldJob</li>
<li>Main qui orchestre avec Either</li>
<li>Tests avec ScalaTest</li>
<li>Fat JAR et script spark-submit</li>
</ol>
</section>
<section id="donnÃ©es" class="level3">
<h3 class="anchored" data-anchor-id="donnÃ©es">DonnÃ©es</h3>
<p><strong><code>data/raw/transactions_*.json</code></strong> (plusieurs fichiers) :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">"transaction_id"</span><span class="fu">:</span> <span class="st">"TXN001"</span><span class="fu">,</span> <span class="dt">"customer_id"</span><span class="fu">:</span> <span class="st">"C001"</span><span class="fu">,</span> <span class="dt">"amount"</span><span class="fu">:</span> <span class="fl">150.0</span><span class="fu">,</span> <span class="dt">"category"</span><span class="fu">:</span> <span class="st">"Electronics"</span><span class="fu">,</span> <span class="dt">"timestamp"</span><span class="fu">:</span> <span class="st">"2024-01-15T10:30:00Z"</span><span class="fu">}</span></span></code></pre></div><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="jobs-Ã -implÃ©menter" class="level3">
<h3 class="anchored" data-anchor-id="jobs-Ã -implÃ©menter">Jobs Ã  implÃ©menter</h3>
<p><strong>BronzeJob</strong> : - Lire les JSON - Ajouter <code>_ingestion_timestamp</code>, <code>_source_file</code> - Ã‰crire en Delta (append)</p>
<p><strong>SilverJob</strong> : - Lire Bronze - Valider schÃ©ma - DÃ©dupliquer par <code>transaction_id</code> - Filtrer <code>amount &gt; 0</code> - Ã‰crire en Delta avec MERGE</p>
<p><strong>GoldJob</strong> : - Lire Silver - AgrÃ©gations : ventes par catÃ©gorie, par jour - Top customers - Ã‰crire plusieurs tables Gold</p>
<hr>
</section>
</section>
<section id="ressources" class="level2">
<h2 class="anchored" data-anchor-id="ressources">ğŸ“š Ressources</h2>
<section id="documentation" class="level3">
<h3 class="anchored" data-anchor-id="documentation">Documentation</h3>
<ul>
<li><a href="https://docs.scala-lang.org/">Scala Documentation</a></li>
<li><a href="https://spark.apache.org/docs/latest/api/scala/">Spark Scala API</a></li>
<li><a href="https://www.scala-sbt.org/1.x/docs/">sbt Documentation</a></li>
<li><a href="https://docs.delta.io/latest/api/scala/">Delta Lake Scala API</a></li>
</ul>
</section>
<section id="livres" class="level3">
<h3 class="anchored" data-anchor-id="livres">Livres</h3>
<ul>
<li><em>Programming in Scala</em> â€” Martin Odersky</li>
<li><em>Functional Programming in Scala</em> â€” Paul Chiusano, RÃºnar Bjarnason</li>
<li><em>Spark: The Definitive Guide</em> â€” Bill Chambers, Matei Zaharia</li>
</ul>
</section>
<section id="outils" class="level3">
<h3 class="anchored" data-anchor-id="outils">Outils</h3>
<ul>
<li><a href="https://www.jetbrains.com/idea/">IntelliJ IDEA</a> â€” IDE</li>
<li><a href="https://almond.sh/">Almond</a> â€” Kernel Scala pour Jupyter</li>
<li><a href="https://scalameta.org/metals/">Metals</a> â€” LSP pour VS Code</li>
</ul>
<hr>
</section>
</section>
<section id="prochaine-Ã©tape" class="level2">
<h2 class="anchored" data-anchor-id="prochaine-Ã©tape">â¡ï¸ Prochaine Ã©tape</h2>
<p>ğŸ‘‰ <strong>Module suivant : <code>31_ml_engineering</code></strong> â€” ML Engineering</p>
<hr>
<p>ğŸ‰ <strong>FÃ©licitations !</strong> Tu maÃ®trises maintenant Scala pour Spark et les optimisations avancÃ©es.</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Retour au sommet</a></main> <!-- /main -->
<!-- ===== Floating PDF Download Button ===== -->

<style>
#pdf-button {
  position: fixed;
  bottom: 80px;  /* Plus haut pour Ã©viter le bouton back-to-top de Quarto */
  right: 20px;
  background: linear-gradient(135deg, #00b4d8, #0077b6);
  color: white;
  padding: 12px 20px;
  border-radius: 30px;
  box-shadow: 0 4px 15px rgba(0, 180, 216, 0.4);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  z-index: 1000;
  transition: all 0.3s ease;
  border: none;
  display: flex;
  align-items: center;
  gap: 8px;
}

#pdf-button:hover {
  background: linear-gradient(135deg, #0077b6, #005f8a);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 119, 182, 0.5);
}

#pdf-button:active {
  transform: translateY(0);
}

/* Responsive - plus petit sur mobile */
@media (max-width: 768px) {
  #pdf-button {
    bottom: 70px;
    right: 15px;
    padding: 10px 16px;
    font-size: 13px;
  }
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  #pdf-button {
    background: linear-gradient(135deg, #0096c7, #0077b6);
    box-shadow: 0 4px 15px rgba(0, 150, 199, 0.3);
  }
  
  #pdf-button:hover {
    background: linear-gradient(135deg, #00b4d8, #0096c7);
    box-shadow: 0 6px 20px rgba(0, 180, 216, 0.4);
  }
}
</style>

<button id="pdf-button" onclick="downloadPDF()" aria-label="TÃ©lÃ©charger en PDF">
  ğŸ“„ TÃ©lÃ©charger en PDF
</button>

<script>
function downloadPDF() {
  window.print();
}
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "CopiÃ©");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "CopiÃ©");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/diakite-data\.github\.io\/data-engineering-bootcamp");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="preferred_color_scheme">
<input type="hidden" id="giscus-alt-theme" value="preferred_color_scheme">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "diakite-data/data-engineering-bootcamp";
    script.dataset.repoId = "R_kgDOQjHMsg";
    script.dataset.category = "General";
    script.dataset.categoryId = "DIC_kwDOQjHMss4CzeOO";
    script.dataset.mapping = "pathname";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "fr";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../notebooks/advanced/29_distributed_messaging.html" class="pagination-link" aria-label="29 Â· Messaging DistribuÃ© (Kafka, Pulsar)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">29 Â· Messaging DistribuÃ© (Kafka, Pulsar)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../notebooks/advanced/31_data_engineering_for_ml.html" class="pagination-link" aria-label="31 Â· Data Engineering pour le ML">
        <span class="nav-page-text">31 Â· Data Engineering pour le ML</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Fait par DIAKITE YOUSSOUF</p>
</div>   
    <div class="nav-footer-center">
<p>Â© 2026 Bootcamp Data Engineering Â· From Zero to Hero</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/diakite-data/data-engineering-bootcamp/blob/main/notebooks/advanced/30_spark_scala_deep_dive.ipynb" class="toc-action"><i class="bi bi-github"></i>Voir la source</a></li><li><a href="https://github.com/diakite-data/data-engineering-bootcamp/issues/new" class="toc-action"><i class="bi empty"></i>Faire part d'un problÃ¨me</a></li><li><a href="https://github.dev/diakite-data/data-engineering-bootcamp/blob/main/notebooks/advanced/30_spark_scala_deep_dive.ipynb" class="toc-action"><i class="bi empty"></i>Modifier cette page</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/diakite-data/data-engineering-bootcamp">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/diakite-data">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<!-- Reading Progress Indicator -->
<div class="reading-progress" aria-hidden="true"></div>

<!-- UI Enhancement Scripts -->
<script src="../../bootcamp-ui.js"></script>
<script src="../../sidebar-toggle.js"></script>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>